<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Kongsberg MBES file parser</title>
	<style>
		.drop-area {
			border: 2px dashed #ccc;
			border-radius: 20px;
			width: 480px;
			font-family: sans-serif;
			margin: 100px auto;
			padding: 20px;
		}

		.highlight {
			border-color: purple;
		}

		.fileElem {
			display: none;
		}
		.button {
			border: 2px solid #4CAF50;
			background-color: white;
			color: black;
			cursor: pointer;
		}

		.btnDraw {
			display: none;
		}
	</style>
</head>
<body class="container-fluid">
	<div id="page-wrapper">
		<div id="areaFileGroup"></div>

		<h1>Kongsberg MBES file parser</h1>
		<span><button class="btnDraw" onclick="drawTest2D()">Draw 1px</button></span>
		<span><button class="btnDraw" onclick="drawTest2D3px()">Draw 3px HSL</button></span>
		<span><button class="btnDraw" onclick="drawTest2DSlow()">Draw Slow</button></span>

		<div id="drop-area" class="drop-area">
			<form>
				<span>Upload multiple files with the file dialog or by dragging and dropping</span>
				<br>
				<input type="file" id="fileElem" multiple accept=".all" class="fileElem">
				<label class="button" for="fileElem">Select some files</label>
			</form>
		</div>
	</div>

	<div>
		<canvas id="canvas" width="1000" height="1000"></canvas>
		<span id="areaText" style="width: 500px; height: 500; display: inline-block; border-style: dotted;"></div>
	</div>
</body>

<script type="text/javascript">
	// -- https://css-tricks.com/converting-color-spaces-in-javascript/
	function HSLToHex(h,s,l) {
		s /= 100;
		l /= 100;

		let c = (1 - Math.abs(2 * l - 1)) * s,
			x = c * (1 - Math.abs((h / 60) % 2 - 1)),
			m = l - c/2,
			r = 0,
			g = 0,
			b = 0;

		if (0 <= h && h < 60) {
			r = c; g = x; b = 0;
		} else if (60 <= h && h < 120) {
			r = x; g = c; b = 0;
		} else if (120 <= h && h < 180) {
			r = 0; g = c; b = x;
		} else if (180 <= h && h < 240) {
			r = 0; g = x; b = c;
		} else if (240 <= h && h < 300) {
			r = x; g = 0; b = c;
		} else if (300 <= h && h < 360) {
			r = c; g = 0; b = x;
		}

		r = Math.round((r + m) * 255);
		g = Math.round((g + m) * 255);
		b = Math.round((b + m) * 255);

		// !! notice it is not rgb, bgr !!
		// let rgb = 0xFF000000 | r << 16 | g << 8 | b;
		let bgr = 0xFF000000 | b << 16 | g << 8 | r;
		return bgr;
	}

	const hslColor = [];
	for(let i = 0; i <= 360; i++) {
		hslColor.push(HSLToHex(i, 50, 50));
	}

	// -- Saving Color Map
	window.hslColorMap = hslColor; // 0 ~ 360
	
</script>
<script type="text/javascript" src="./js/Misc.js"></script>
<script type="module">
	import DNDFileList from './jsm/DNDFileList.js'
	import {EMParamInstall, EMParamRuntime, EMPosition, EMXYZ88, EMAll, EMAllBatch2020} from './jsm/EMFileFormat.js';
	import Canvas2DPixel from './jsm/Canvas2DPixel.js';
	
	DNDLocalFile(document.getElementById('drop-area'), (files) => {
		// -- Hide drop area
		document.getElementById('drop-area').style.display = 'none';

		const dndFL = new DNDFileList(['all']);

		for(let file of files) {
			dndFL.addFile(file);
		}

		// -- Should be called after addFile
		dndFL.setButton('areaFileGroup', async (files) => {
			const ab = await DNDFileList.readFileArrayBuffer(files[0]);
			const all = new EMAllBatch2020(ab);
			window.fileRead = all;

			const btns = document.getElementsByClassName('btnDraw');
			for(let btn of btns) {
				btn.style.display = 'inline-block';
			}
		});
	});

	window.drawTest2D = () => {
		const minMax = fileRead.batch20200607();

		const c = new Canvas2DPixel('canvas');
		c.newImage();

		let i = 0;

		const start = new Date().getTime();
		fileRead.getXYZSource().forEach((item) => {
			item.xyz.forEach((xyz) => {
				if(i > 100) {
					// return;
				}
				const latV = minMax.lat.max - minMax.lat.min;
				const lngV = minMax.lng.max - minMax.lng.min;
				const zV = minMax.z.max - minMax.z.min;

				const y = parseInt((xyz.lat - minMax.lat.min) / latV * c.h);
				const x = parseInt((xyz.lng - minMax.lng.min) / lngV * c.w);
				const color = (xyz.z - minMax.z.min) / zV * 255;

				c.draw32(x, y, color << 24 || 0xFFFFFF);
				i++;
			});
		});

		c.putImage();
		const end = new Date().getTime();

		console.log(`done put image ${end - start}ms`);
	}

	window.drawTest2D3px = () => {
		const minMax = fileRead.batch20200607();

		const start = new Date().getTime();
		const c = new Canvas2DPixel('canvas');
		c.newImage();

		let i = 0;

		fileRead.getXYZSource().forEach((item) => {
			item.xyz.forEach((xyz) => {
				if(i > 100) {
					// return;
				}
				const latV = minMax.lat.max - minMax.lat.min;
				const lngV = minMax.lng.max - minMax.lng.min;
				const zV = minMax.z.max - minMax.z.min;

				const y = parseInt((xyz.lat - minMax.lat.min) / latV * c.h);
				const x = parseInt((xyz.lng - minMax.lng.min) / lngV * c.w);
				const rgba = hslColorMap[parseInt((xyz.z - minMax.z.min) / zV * 360)];

				c.draw32triple(x, y, rgba);
				i++;
			});
		});

		c.putImage();

		const end = new Date().getTime();

		console.log(`done put image ${end - start}ms`);
	}

	// -- Slowly
	window.drawTest2DSlow = () => {
		const minMax = fileRead.batch20200607();
		const txtP = document.getElementById('areaText');

		const start = new Date().getTime();
		const c = new Canvas2DPixel('canvas');
		c.newImage();

		let i = 0;
		let timeInterval = 10;
		const listXYZSrc = fileRead.getXYZSource();

		const funcRun = () => {
			const data = listXYZSrc[i];
			// -- Draw Text
			const detail = data.parsedDetail;
			const line = [
				`Date: ${data.getTimestamp()}`,
				`Pos: ${data.referencedPos.getPositionStr()}`,
				`Model / Serial: ${detail.model} / ${detail.serial}`,
				`Ping Counter in File: ${i + 1} / ${listXYZSrc.length}`,
				`Ping Counter in Project: ${detail.pingCounter}`,
				`Valid: ${detail.body.length}`,
				`Freq: ${detail.freq}Hz`,
				`HDT: ${detail.heading / 100}Degree`,
				`SoundSpeed: ${detail.ss / 10}m/s`
			]
			txtP.innerText = line.join('\n');

			data.xyz.forEach((xyz) => {
				const latV = minMax.lat.max - minMax.lat.min;
				const lngV = minMax.lng.max - minMax.lng.min;
				const zV = minMax.z.max - minMax.z.min;

				const y = parseInt((xyz.lat - minMax.lat.min) / latV * c.h);
				const x = parseInt((xyz.lng - minMax.lng.min) / lngV * c.w);
				const rgba = hslColorMap[parseInt((xyz.z - minMax.z.min) / zV * 360)];

				c.draw32triple(x, y, rgba);
			});

			c.putImage();

			i++;

			if(listXYZSrc.length > i) {
				funcDoNext();
			}
		}

		const funcDoNext = () => {
			setTimeout(() => {
				funcRun();
			}, timeInterval);
		}

		funcRun();

	}
</script>

</html>
