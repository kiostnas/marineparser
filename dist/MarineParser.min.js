!function(){class t{static getValueFromObject(t,e){const s=e.match(/([^\.\[]*)/g),a=[];if(s.forEach((t=>{0!==t.length&&(t.match(/(\d+)\]$/)?a.push(parseInt(t)):a.push(t))})),0===a.length)return void console.log(`getValueFromObject Invalid expression ${t}, '${e}'`);let r=t;return a.forEach((t=>r=r[t])),r}}class e{constructor(){this.clear()}now(t){this.timestamp.push({ts:(new Date).getTime(),title:t})}clear(){this.timestamp=[]}outconsole(){for(let t=1;t<this.timestamp.length;t++){const e=this.timestamp[t-1],s=this.timestamp[t],a=s.ts-e.ts;console.log(`${a}ms - ${e.title} ~ ${s.title}`)}}}class s{
/*!
	* JavaScript function to calculate the destination point given start point latitude / longitude (numeric degrees), bearing (numeric degrees) and distance (in m).
	*
	* Original scripts by Chris Veness
	* Taken from http://movable-type.co.uk/scripts/latlong-vincenty-direct.html and optimized / cleaned up by Mathias Bynens <http://mathiasbynens.be/>
	* Based on the Vincenty direct formula by T. Vincenty, “Direct and Inverse Solutions of Geodesics on the Ellipsoid with application of nested equations”, Survey Review, vol XXII no 176, 1975 <http://www.ngs.noaa.gov/PUBS_LIB/inverse.pdf>
	*/
static toRad(t){return t*Math.PI/180}static toDeg(t){return 180*t/Math.PI}static destVincenty(t,e,a,r){for(var i=6378137,n=6356752.3142,o=1/298.257223563,l=r,c=s.toRad(a),h=Math.sin(c),p=Math.cos(c),d=(1-o)*Math.tan(s.toRad(t)),u=1/Math.sqrt(1+d*d),f=d*u,g=Math.atan2(d,p),D=u*h,T=1-D*D,m=T*(i*i-n*n)/(n*n),U=1+m/16384*(4096+m*(m*(320-175*m)-768)),S=m/1024*(256+m*(m*(74-47*m)-128)),E=l/(n*U),I=2*Math.PI;Math.abs(E-I)>1e-12;){var P=Math.cos(2*g+E),M=Math.sin(E),A=Math.cos(E);I=E,E=l/(n*U)+S*M*(P+S/4*(A*(2*P*P-1)-S/6*P*(4*M*M-3)*(4*P*P-3)))}var v=f*M-u*A*p,y=Math.atan2(f*A+u*M*p,(1-o)*Math.sqrt(D*D+v*v)),C=o/16*T*(4+o*(4-3*T)),_=Math.atan2(M*h,u*A-f*M*p)-(1-C)*o*D*(E+C*M*(P+C*A*(2*P*P-1)));Math.atan2(D,-v);return{lat:s.toDeg(y),lng:e+s.toDeg(_)}}static destination(t,e,a,r){return s.destVincenty(t,e,a,r)}static distance(t,e,a,r){var i=s.toRad(r-e),n=s.toRad(a-t),o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(s.toRad(e))*Math.cos(s.toRad(r))*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}static DM2D(t){var e=Math.abs(t),s=Math.floor(e/100),a=s+(e-100*s)/60;return t<0&&(a*=-1),a}static D2DM(t){var e=Math.abs(parseInt(t));return e=100*e+60*(Math.abs(t)-e),t<0&&(e*=-1),e}}class a{constructor(){this.centerPos=[0,0],this.widthToDegree=1,this.heightToDegree=1,this.mapSize=[500,500],this.mapPixel=[250,250],this.zoomLevel=1,this.xDistance=111,this.yDistance=111,this.setCenterPos([0,0]),this.setDistance(1),this.setMapSize([500,500])}setCenterPos(t){if(2!==t.length)return void console.error("Invalid pos, should be 2 length array");if(90<t[0]||-90>t[0])return void console.error("Latitude should be with in -90 ~ 90");if(180<t[1]||-180>t[1])return void console.error("Longitude should be with in -180 ~ 180");const e=s.distance(t[1],t[0],t[1]+1,t[0]),a=s.distance(t[1],t[0],t[1],t[0]+1);this.xDistance=e,this.yDistance=a,this.centerPos=t,this.calculateUnit()}setMapSize(t){2===t.length?0>=t[0]||0>=t[1]?console.error("Invalid size, should be bigger than zero!"):(this.mapSize=t,this.mapPixel=[t[0]/2,t[1]/2],this.calculateUnit()):console.error("Map size should be 2 length array, width, height")}setDistance(t){this.heightToDegree=t,this.widthToDegree=t/(this.yDistance/this.xDistance),this.calculateUnit()}calculateUnit(){const t=this.mapSize[0]/this.widthToDegree,e=this.mapSize[1]/this.heightToDegree;this.xUnit=t,this.yUnit=e}static DiffX(t,e){let s=0;return s=e-t,0>t&&e>0?(s=180+t+(180-e),s*=-1):0<t&&e<0&&(s=180-t+(180+e)),s}static DiffY(t,e){return-1*(e-t)}getPixel(t){return[this.getPixelLng(t[1]),this.getPixelLat(t[0])]}getPixelLat(t){const e=a.DiffY(this.centerPos[0],t);return~~(this.mapPixel[1]+e*this.yUnit)}getPixelLng(t){const e=a.DiffX(this.centerPos[1],t);return~~(this.mapPixel[0]+e*this.xUnit)}getInfo(){const t=[];return t.push(`Size of box : w * h - ${this.mapSize[0]} * ${this.mapSize[1]} pixel`),t.push(`Width / Height to 1 Degree at [${this.centerPos[0]}, ${this.centerPos[1]}] : ${this.xDistance} / ${this.yDistance}`),t.push(`ZoomLevel : ${this.zoomLevel}`),t}calculateZoomDistance(){this.setDistance(Math.pow(10,this.zoomLevel/10))}zoom(t){isNaN(t)||(this.zoomLevel=t,this.calculateZoomDistance())}zoomOut(){this.zoomLevel=this.zoomLevel+1,this.calculateZoomDistance()}zoomIn(){this.zoomLevel=this.zoomLevel-1,this.calculateZoomDistance()}zoomAdjust(...t){const e=t.map((t=>t[0])),s=t.map((t=>t[1])),r=[Math.min(...e),Math.min(...s)],i=[Math.max(...e),Math.max(...s)],n=a.DiffY(r[0],i[0]),o=a.DiffX(r[1],i[1]),l=[r[0]+Math.abs(n/2),r[1]+Math.abs(o/2)];this.setCenterPos(l);let c=10;for(;c>-100;c--){this.zoom(c);const t=d2p.getPixelLat(r[0]),e=d2p.getPixelLng(r[1]);if(t<0||e<0||t>this.mapSize[1]||e>this.mapSize[0])break}return c++,this.zoom(c),c}}class r extends DataView{constructor(t,e,s){super(t,e,s),this.littleEndian=!1,this.initParser()}setLittleEndian(t){this.littleEndian=t}setParseOffset(t){this.parseOffset=t}addParseOffset(t){this.parseOffset=this.parseOffset+t}getInt16(t){return super.getInt16(t,this.littleEndian)}getInt32(t){return super.getInt32(t,this.littleEndian)}getUint16(t){return super.getUint16(t,this.littleEndian)}getUint32(t){return super.getUint32(t,this.littleEndian)}getBigInt64(t){return super.getBigInt64(t,this.littleEndian)}getBigUint64(t){return super.getBigUint64(t,this.littleEndian)}getFloat32(t){return super.getFloat32(t,this.littleEndian)}getFloat64(t){return super.getFloat64(t,this.littleEndian)}initParser(){const t={};t.U1=[this.getUint8.bind(this),1],t.U2=[this.getUint16.bind(this),2],t.U4=[this.getUint32.bind(this),4],t.U8=[this.getBigUint64.bind(this),8],t.I1=[this.getInt8.bind(this),1],t.I2=[this.getInt16.bind(this),2],t.I4=[this.getInt32.bind(this),4],t.I8=[this.getBigInt64.bind(this),8],t.F4=[this.getFloat32.bind(this),4],t.F8=[this.getFloat64.bind(this),8],this.mapParser=t,this.parseOffset=0}parse(t,e){const s=this;if(void 0!==e&&0<=e&&(this.parseOffset=e),!t)return console.log(`Invalid struct ${t}`),!1;const a=this.mapParser,r={};return!0!=t instanceof Map?(console.error("map should be Map type, no other objects"),!1):(t.forEach(((t,e)=>{const i=a[t][0];"function"==typeof i&&(r[e]=i(s.parseOffset),s.parseOffset=s.parseOffset+a[t][1])})),r)}parseArray(t,e,s){if(void 0!==s&&0<=s&&(this.parseOffset=s),isNaN(e))return console.log(`Invalid count ${e} should be number`),!1;const a=this.mapParser,r=[],i=a[t][0],n=a[t][1];if("function"!=typeof i)return console.log(`Invalid type ${t} should be in list`),!1;for(let t=0;t<e;t++){const t=i(this.parseOffset);r.push(t),this.addParseOffset(n)}return r}calcLengthStruct(t){if(!0!=t instanceof Map)return console.error("map should be Map type, no other objects"),!1;let e=0;const s=this.mapParser;return t.forEach(((t,a)=>{const r=s[t][1];e+=r})),e}toAsciiString(t,e){const s=this.buffer.slice(this.byteOffset+t,this.byteOffset+e);return String.fromCharCode.apply(null,new Uint8Array(s))}saveBrief(t){this.parsedBrief=t}saveDetail(t){this.parsedDetail=t}getBrief(){return this.parsedBrief}getDetail(){return this.parsedDetail}}class n{constructor(){this.files={bl:void 0,hdr:void 0,hex:void 0,xmlcon:void 0},this.instance={bl:void 0,hdr:void 0,hex:void 0,xmlcon:void 0}}addFile(t){const e=t.name.match(/^(.*)\.([^.]*)$/i);if(e){e[1];const s=e[2].toLowerCase();-1!==["hex","bl","hdr","xmlcon"].findIndex((t=>s===t))&&(this.files[s]=t)}}async parse(){if(this.files.hex){const t=new h;this.instance.hex=t,t.setParent(this),await t.setFile(this.files.hex)}if(this.files.xmlcon){const t=new p;this.instance.xmlcon=t,t.setParent(this),await t.setFile(this.files.xmlcon)}if(this.files.hdr){const t=new l;this.instance.hdr=t,t.setParent(this),await t.setFile(this.files.hdr)}if(this.files.bl){const t=new c;this.instance.bl=t,t.setParent(this),await t.setFile(this.files.bl)}}unload(){}getHex(){return this.instance.hex}getXmlcon(){return this.instance.xmlcon}getHdr(){return this.instance.hdr}getBl(){return this.instance.bl}}class o{constructor(){this.parent=void 0}setParent(t){this.parent=t}getHex(){if(this.parent)return this.parent.getHex()}getXmlcon(){if(this.parent)return this.parent.getXmlcon()}getBl(){if(this.parent)return this.parent.getBl()}getHdr(){if(this.parent)return this.parent.getHdr()}}class l extends o{constructor(){super(),this.file=void 0,this.parsedHDR=void 0}static parseHDR(t){const e={bytes:t.match(/Number of Bytes Per Scan = (.*)$/m),lat:t.match(/NMEA Latitude = (.*)$/m),lng:t.match(/NMEA Longitude = (.*)$/m),utc:t.match(/NMEA UTC \(Time\) = (.*)$/m),scanAvg:t.match(/Number of Scans Averaged by the Deck Unit = (.*)$/m)};if(e.bytes&&(e.bytes=parseInt(e.bytes[1])),e.lat){e.nmeaLat=e.lat[1];const t=e.lat[1].match(/(\d*) ([\d\.]*) (N|S)/);if(t){const s=parseInt(t[1]),a=parseFloat(t[2])/60;e.lat=s+a,"S"===t[3]&&(e.lat=-1*e.lat)}}if(e.lng){e.nmeaLng=e.lng[1];const t=e.lng[1].match(/(\d*) ([\d\.]*) (E|W)/);if(t){const s=parseInt(t[1]),a=parseFloat(t[2])/60;e.lng=s+a,"W"===t[3]&&(e.lng=-1*e.lng)}}if(e.utc){const t=e.utc[1],s=new Date(t);e.nmeaUTC=t,e.utc=s}return e.scanAvg&&(e.scanAvg=parseInt(e.scanAvg[1])),e}async setFile(t){return new Promise(((e,s)=>{const a=new FileReader;a.onloadend=()=>{this.setDataSource(a.result),e()},a.readAsText(t)}))}setDataSource(t){this.dataSource=t;const e=l.parseHDR(this.dataSource);this.parsedHDR=e}getParsedHDR(){return this.parsedHDR}}class c extends o{constructor(){super(),this.file=void 0,this.dataSource=void 0}static parseBL(t){const e={};let s=0;t.split("\n").forEach((t=>{const a=c.parseBLLine(t);a&&(s++,e[a.fired]=a)}));return{countFired:s,fired:e}}static parseBLLine(t){const e=t.split(",");if(5!==e.length)return!1;return{fired:parseInt(e[1]),dateStr:e[2],rawLineS:parseInt(e[3]),rawLineE:parseInt(e[4])}}static parseBLHEX(t,e){t.fired&&e&&Object.keys(t.fired).forEach((s=>{const a=t.fired[s],r=e.parseValue(a.rawLineS),i=r.value.altimeter;r.value.f2depth,r.value.f0,r.value.f1psu;i&&(a.altimeter=r.value.altimeter),a.depth=r.value.f2depth,a.t=r.value.f0,a.s=r.value.f1psu}))}async setFile(t){return new Promise(((e,s)=>{const a=new FileReader;a.onloadend=()=>{this.setDataSource(a.result),e()},a.readAsText(t)}))}setDataSource(t){this.dataSource=t;const e=c.parseBL(this.dataSource);if(!this.getHex())return console.error("SeaSaveBL.setDataSource : got no hex, can not proceed"),void console.log(e);c.parseBLHEX(e,this.getHex()),this.parsedBL=e}getParsedBL(){return this.parsedBL}}class h extends o{static TIME_BASE_MS=9466848e5;constructor(){super(),this.file=void 0,this.dataSource=void 0,this.parsingDesc={countFreq:3,countAD:0,countADWords:0,surfacePar:!1,nmeaPosition:!1,nmeaDepth:!1,nmeaTime:!1,scanTime:!1,scanAvg:-99}}async setFile(t){return new Promise(((e,s)=>{const a=new FileReader;a.onloadend=()=>{this.setDataSource(a.result),e()},a.readAsText(t)}))}setDataSource(t){this.updateParsingDescription();const e=t.split("\n");this.header=[];for(let t=0;t<e.length;t++){const s=e[t];s.match(/^\*.*/)?this.header.push(s):(this.dataSource=[],e.slice(t).forEach((t=>this.dataSource.push(this.ascii2ta(t)))),t=e.length+1)}this.parseHeader()}ascii2ta(t){const e=new Uint8Array(t.length/2);let s=0;for(let a=0;a<t.length;a+=2){const r=(parseInt(t[a],16)<<4)+parseInt(t[a+1],16);e[s++]=r}return e}parseHeader(){const t=l.parseHDR(this.header.join("\n"));if(this.parsedHDR=t,1===this.parsedHDR.scanAvg){const t=parseInt(this.getLength()/24);this.parsedHDR.scanDuration=t}else this.parsedHDR.scanDuration=-99}getRaw(t){if(this.dataSource&&t<this.dataSource.length)return this.dataSource[t]}parseValue(t){const e=this.getXmlcon();if(!e)return console.error("SeaSaveHex.getValue : No xmlcon given"),!1;const s=e.getParsedMap(),a=e.findSensorKeyByType("Altimeter"),r=this.parseRaw(t),i=r.psT*s.f2.coef.AD590M+s.f2.coef.AD590B,n=s.f0.getValue(r.f0).DegreeC,o=s.f2.getValue(r.f2,i).psi,l=d.PSI2Decibar(o),c=d.DECIBAR2Depth(l,r.lat),h=s.f1.getValue(r.f1,n,l).SPerM,p=d.COND2PSU(h,n,l);if(r.value={f0:n,f1:h,f1psu:p,f2:o,f2decibar:l,f2depth:c},a){const t=r[a],e=s[a].getValue(t).meter;r.value.altimeter=e}return r}parseRaw(t){const e=this.getRaw(t);return this._parseBasic(e)}parseDepthOnly(t){const e=this.getRaw(t);return this._parseDepthOnly(e)}_parseBasic(t){const e={},s=this.parsingDesc;let a=0;for(let r=0;r<s.countFreq;r++)e["f"+r]=256*t[a++]+t[a++]+t[a++]/256;const r=[];for(let e=0;e<s.countADWords;e++)r.push(t[a++]<<16|t[a++]<<8|t[a++]);let i=0;if(r.forEach((t=>{e["v"+i]=5*(1-(t>>>12)/4095),i++,e["v"+i]=5*(1-(4095&t)/4095),i++})),s.surfacePar){a++;const s=t[a++]<<8|t[a++];e.spV=(4095&s)/819}if(s.nmeaPosition){let s=(65536*t[a++]+256*t[a++]+t[a++])/5e4,r=(65536*t[a++]+256*t[a++]+t[a++])/5e4;const i=t[a++];1===i&128&&(s*=-1),1===i&64&&(r*=-1),e.lat=s,e.lng=r}if(s.nmeaTime){const s=t[a++]|t[a++]<<8|t[a++]<<16|t[a++]<<24,r=h.TIME_BASE_MS+1e3*s;e.date=new Date(r),e.dateMS=r}const n=t[a++]<<8|t[a++];return e.psT=n>>>4,e.CTDStatus={pump:1==(1&n),bot:2==(2&n),ws:4==(4&n),cr:8==(8&n),s:(15&n).toString(2).padStart(4,"0")},e.moduloCount=t[a++],e}_parseDepthOnly(t){const e={},s=this.parsingDesc;let a=0;if(a=6,e.f2=256*t[a++]+t[a++]+t[a++]/256,a=3*s.countFreq,a+=3*s.countADWords,s.surfacePar&&(a+=3),s.nmeaPosition){let s=(65536*t[a++]+256*t[a++]+t[a++])/5e4,r=(65536*t[a++]+256*t[a++]+t[a++])/5e4;const i=t[a++];1===i&128&&(s*=-1),1===i&64&&(r*=-1),e.lat=s,e.lng=r}s.nmeaTime&&(a+=4);const r=t[a++]<<8|t[a++];return e.psT=r>>>4,e}updateParsingDescription(){const t=this.getXmlcon();if(!t)return;const e=t.getInstrument(),s=5-e.freqSuppress,a=8-e.voltSuppress,r=a/2,i=1===e.surfacePar,n=1===e.nmeaPosition,o=1===e.nmeaDepth,l=1===e.nmeaTime,c=1===e.scanTime;this.parsingDesc={countFreq:s,countAD:a,countADWords:r,surfacePar:i,nmeaPosition:n,nmeaDepth:o,nmeaTime:l,scanTime:c,scanAvg:e.scanAvg}}getLength(){return this.dataSource?this.dataSource.length:0}getParsingDescription(){return this.parsingDesc}getParsedHDR(){return this.parsedHDR}unload(){this.dataSource=void 0}}class p extends o{static SENSOR_MAP=[{sensorID:3,attribute:"ConductivitySensor",title:"Conductivity",coef:{CPcor:"Coefficients[1].CPcor",CTcor:"Coefficients[1].CTcor",G:"Coefficients[1].G",H:"Coefficients[1].H",I:"Coefficients[1].I",J:"Coefficients[1].J",WBOTC:"Coefficients[1].WBOTC"},getValue:(t,e,s,a)=>{const r=e/1e3;return{SPerM:(t.G+t.H*Math.pow(r,2)+t.I*Math.pow(r,3)+t.J*Math.pow(r,4))/10*(1+t.CTcor*s+t.CPcor*a)}}},{sensorID:55,attribute:"TemperatureSensor",title:"Temperature",coef:["F0","G","H","I","J","Offset","Slope","UseG_J"],getValue:(t,e)=>{const s=t.F0/e,a=Math.log(s);return{DegreeC:1/(t.G+t.H*a+t.I*Math.pow(a,2)+t.J*Math.pow(a,3))-273.15}}},{sensorID:45,attribute:"PressureSensor",title:"Pressure",coef:["AD590B","AD590M","C1","C2","C3","D1","D2","Offset","Slope","T1","T2","T3","T4","T5"],getValue:(t,e,s)=>{const a=t.C1+t.C2*s+t.C3*Math.pow(s,2),r=t.D1+t.D2*s,i=t.T1+t.T2*s+t.T3*Math.pow(s,2)+t.T4*Math.pow(s,3)+t.T5*Math.pow(s,4),n=1/e*1e6,o=a*(1-Math.pow(i,2)/Math.pow(n,2))*(1-r*(1-Math.pow(i,2)/Math.pow(n,2)));return{psia:o,psi:o-14.7}}},{sensorID:38,attribute:"OxygenSensor",title:"Oxygen",coef:{A:"CalibrationCoefficients[1].A",B:"CalibrationCoefficients[1].B",C:"CalibrationCoefficients[1].C",D0:"CalibrationCoefficients[1].D0",D1:"CalibrationCoefficients[1].D1",D2:"CalibrationCoefficients[1].D2",E:"CalibrationCoefficients[1].E",H1:"CalibrationCoefficients[1].H1",H2:"CalibrationCoefficients[1].H2",H3:"CalibrationCoefficients[1].H3",Soc:"CalibrationCoefficients[1].Soc",Tau20:"CalibrationCoefficients[1].Tau20",offset:"CalibrationCoefficients[1].offset"}},{sensorID:71,attribute:"WET_LabsCStar",title:"Transmissometer",coef:["B","M","PathLength"]},{sensorID:20,attribute:"FluoroWetlabECO_AFL_FL_Sensor",title:"Fluorometer",coef:["ScaleFactor","Vblank"]},{sensorID:42,attribute:"PAR_BiosphericalLicorChelseaSensor",title:"PAR_Biospherical",coef:["B","M","Multiplier","Offset"]},{sensorID:0,attribute:"AltimeterSensor",title:"Altimeter",coef:["ScaleFactor","Offset"],getValue:(t,e)=>({meter:300*e/t.ScaleFactor+t.Offset})},{sensorID:27,attribute:"NotInUse",title:"NotInUse"}];constructor(){super(),this.file=void 0,this.dataSource=void 0,this.parsedMap={f0:void 0,f1:void 0,f2:void 0,f3:void 0,f4:void 0,v0:void 0,v1:void 0,v2:void 0,v3:void 0,v4:void 0,v5:void 0,v6:void 0,v7:void 0}}static parseXml(t){var e=null;if(window.DOMParser)try{e=(new DOMParser).parseFromString(t,"text/xml")}catch(t){e=null}return e}static xmlToJson(t){var e={};if(1==t.nodeType){if(t.attributes.length>0){e["@attributes"]={};for(var s=0;s<t.attributes.length;s++){var a=t.attributes.item(s);e["@attributes"][a.nodeName]=a.nodeValue}}}else 3==t.nodeType&&(e=t.nodeValue);if(t.hasChildNodes())for(var r=0;r<t.childNodes.length;r++){var i=t.childNodes.item(r),n=i.nodeName;if(void 0===e[n])e[n]=p.xmlToJson(i);else{if(void 0===e[n].push){var o=e[n];e[n]=[],e[n].push(o)}e[n].push(p.xmlToJson(i))}}return e}static parseCTDXMLConfig(t){const e=[];try{t.SBE_InstrumentConfiguration.Instrument.SensorArray.Sensor.forEach(((t,s)=>{const a=p.parseSensor(t);a&&(a.key=s,e.push(a))}))}catch(t){console.log(t)}return e}static parseSensor(e){const s=e["@attributes"].SensorID,a=p.SENSOR_MAP.find((t=>t.sensorID==s));if(!a)return console.warn(`SeaSaveXMLCON.parseSensor sensor ID not found ${s}`),!1;const r=e[a.attribute],i=r.SerialNumber["#text"];let n,o,l=r.CalibrationDate["#text"];return l||(l=""),a.coef&&("function"==typeof a.coef?n=a.coef(r):"object"==typeof a.coef&&(n={},Array.isArray(a.coef)?a.coef.forEach((e=>{const s=t.getValueFromObject(r,e);s&&s.hasOwnProperty("#text")?n[e]=parseFloat(s["#text"]):(console.error("SeaSaveXMLCON.parseSensor Invalid Coef"),console.error(e))})):Object.keys(a.coef).forEach((e=>{const s=a.coef[e],i=t.getValueFromObject(r,s);i&&i.hasOwnProperty("#text")?n[e]=parseFloat(i["#text"]):(console.error("SeaSaveXMLCON.parseSensor Invalid Coef"),console.error(e))})))),a.getValue&&"function"==typeof a.getValue&&(o=(...t)=>a.getValue(n,...t)),{id:s,type:a.title,serial:i,calibration:l,coef:n,getValue:o}}async setFile(t){return new Promise(((e,s)=>{const a=new FileReader;a.onloadend=()=>{this.setDataSource(a.result),e()},a.readAsText(t)}))}setDataSource(t){const e=p.parseXml(t),s=p.xmlToJson(e);this.dataSource=s,this.parsed=p.parseCTDXMLConfig(s);const a=s.SBE_InstrumentConfiguration.Instrument;this.instrument={freqSuppress:parseInt(a.FrequencyChannelsSuppressed["#text"]),voltSuppress:parseInt(a.VoltageWordsSuppressed["#text"]),nmeaDepth:parseInt(a.NmeaDepthDataAdded["#text"]),nmeaPosition:parseInt(a.NmeaPositionDataAdded["#text"]),nmeaTime:parseInt(a.NmeaTimeAdded["#text"]),scanTime:parseInt(a.ScanTimeAdded["#text"]),surfacePar:parseInt(a.SurfaceParVoltageAdded["#text"]),scanAvg:parseInt(a.ScansToAverage["#text"])},["f0","f1","f2","f3","f4","v0","v1","v2","v3","v4","v5","v6","v7"].forEach(((t,e)=>{const s=this.getSensorAt(e);s&&"NotInUse"!==s.type&&(this.parsedMap[t]=s)}));const r=this.getHex();r&&r.updateParsingDescription()}getInstrument(){return this.instrument}getSensorAt(t){if(this.parsed)return t<this.parsed.length?this.parsed[t]:void 0;console.error(`SeaSaveXMLCON.getSensorAt Not yet parsed ${t}`)}getParsedMap(){return this.parsedMap}findSensorKeyByType(t){const e=this.getParsedMap();if(!e)return console.log("SeaSaveXmlcon.findSensorType : no xml parsed"),!1;let s;return Object.keys(e).forEach((a=>{const r=e[a];r&&t===r.type&&(s=a)})),s}}class d{static D="&deg;";static DC="&deg;C";static SpM="S/m";static PSU="PSU";static M="m";static MpS="m/s";static PSI2Decibar(t){return.689476*t}static DECIBAR2Depth(t,e){let s,a,r;return s=Math.sin(e/57.29578),s*=s,r=9.780318*(1+(.0052788+236e-7*s)*s)+1092e-9*t,a=(((-182e-17*t+2.279e-10)*t-22512e-9)*t+9.72659)*t,r&&(a/=r),a}static COND2PSU(t,e,s){const a=[.008,-.1692,25.3851,14.0941,-7.0261,2.7081],r=[5e-4,-.0056,-.0066,-.0375,.0636,-.0144];let i,n,o,l,c,h,p,d,u;if(t<=0)return 0;for(i=(t*=10)/42.914,d=1+.03426*e+4464e-7*e*e+.4215*i+-.003107*i*e,d&&(o=1+s*(207e-7+s*(3989e-18*s-6.37e-10))/d),d=o*(.6766097+e*(.0200564+e*(.0001104259+e*(1.0031e-9*e-6.9698e-7)))),d&&(n=i/d),n<=0&&(n=1e-6),c=h=0,u=0;u<6;u++)l=Math.pow(n,u/2),c+=a[u]*l,h+=r[u]*l;return d=1+.0162*(e-15),p=d?c+h*(e-15)/d:-99,p}static SVChenMillero(t,e,s){let a,r,i,n,o,l,c,h,p,d,u,f,g,D,T,m,U;return D=s/10,t<0&&(t=0),T=Math.sqrt(t),m=.001727-79836e-10*D,h=73637e-9+1.7945e-7*e,c=-.01922-442e-7*e,l=c+h*D,o=(-3389e-16*e+6649e-15)*e+1.1e-10,n=((7988e-15*e-1.6002e-10)*e+9.1041e-9)*e-3.9064e-7,i=(((-2.0122e-10*e+1.0507e-8)*e-6.4885e-8)*e-1258e-8)*e+94742e-9,r=(((-3.21e-8*e+2006e-9)*e+7164e-8)*e-.01262)*e+1.389,a=((o*D+n)*D+i)*D+r,g=(-23643e-16*e+3.8504e-10)*e-9.7729e-9,f=(((10405e-16*e-2.5335e-10)*e+2.5974e-8)*e-17107e-10)*e+3126e-8,u=(((-6.1185e-10*e+1.3621e-7)*e-81788e-10)*e+68982e-8)*e+.153563,d=((((3.1464e-9*e-1478e-9)*e+3342e-7)*e-.0580852)*e+5.03711)*e+1402.388,p=((g*D+f)*D+u)*D+d,U=p+(a+l*T+m*t)*t,U}}class u extends r{saveDetail(t){super.saveDetail(t),this.parsedDetail.typeTitle=U.getTypeTitle(t.type)}getTimestamp(){if(this.parsedDetail.date&&this.parsedDetail.time){const t=this.parsedDetail.date,e=this.parsedDetail.time,s=parseInt(t/1e4),a=parseInt(t/100%100),r=parseInt(t%100),i=parseInt(e/1e3),n=parseInt(i/60/60),o=parseInt(i/60%60),l=parseInt(e/1e3%60),c=parseInt(e%1e3);return new Date(`${s}-${a}-${r} ${n}:${o}:${l}.${c}`)}return!1}}class f extends u{static STRUCT_INSTALL=new Map([["length","U4"],["stx","U1"],["type","U1"],["model","U2"],["date","U4"],["time","U4"],["lineNo","U2"],["serial","U2"],["serial2ndSonar","U2"]]);parseDetail(){const t=this.parse(f.STRUCT_INSTALL,0),e=this.parseOffset,s=U.getTailOffset(t.length),a=this.parse(U.STRUCT_TAIL,s),r=this.toAsciiString(e,s);return t.params=r,t.etx=a.etx,t.checksum=a.checksum,this.saveDetail(t),t}}class g extends u{static STRUCT_RUNTIME=new Map([["length","U4"],["stx","U1"],["type","U1"],["model","U2"],["date","U4"],["time","U4"],["pingCounter","U2"],["serial","U2"],["operatorStationStatus","U1"],["PUStatus","U1"],["BSPStatus","U1"],["SHTStatus","U1"],["mode","U1"],["filterID","U1"],["minDepth","U2"],["maxDepth","U2"],["absorbCoef","U2"],["txPulseLen","U2"],["txBeamWidth","U2"],["txPower","I1"],["rxBeamWidth","U1"],["rxBandwidth","U1"],["rxGain","U1"],["TVGLawAng","U1"],["srcSS","U1"],["maxPortSwath","U2"],["beamSpacing","U1"],["maxPortCoverage","U1"],["yawPitchStable","U1"],["maxSTBDCoverage","U1"],["maxSTBDSwath","U2"],["txTiltValue","I2"],["filterID2","U1"],["etx","U1"],["checksum","U2"]]);static STRUCT_RUNTIME_DESC={type:"0x52 'R'untime parameter",pingCounter:"0 ~ 65535",serial:"100 ~"};parseDetail(){const t=this.parse(g.STRUCT_RUNTIME,0);return this.saveDetail(t),t}}class D extends u{static STRUCT_POSITION=new Map([["length","U4"],["stx","U1"],["type","U1"],["model","U2"],["date","U4"],["time","U4"],["positionCounter","U2"],["serial","U2"],["lat","I4"],["lng","I4"],["measurePosFixQ","U2"],["speed","U2"],["course","U2"],["heading","U2"],["posSysDesc","U1"],["numInput","U1"]]);parseDetail(){const t=this.parse(D.STRUCT_POSITION,0),e=this.parseOffset,s=U.getTailOffset(t.length),a=this.parse(U.STRUCT_TAIL,s),r=this.toAsciiString(e,s);return t.positionInput=r,t.etx=a.etx,t.checksum=a.checksum,this.saveDetail(t),t}getLatLng(){return{lat:this.parsedDetail.lat/2e7,lng:this.parsedDetail.lng/1e7}}getPositionStr(){const t=this.getLatLng();return`${t.lat.toFixed(4)}, ${t.lng.toFixed(4)}`}}class T extends u{static STRUCT_XYZ_HEAD=new Map([["length","U4"],["stx","U1"],["type","U1"],["model","U2"],["date","U4"],["time","U4"],["pingCounter","U2"],["serial","U2"],["heading","U2"],["ss","U2"],["txTRDepth","F4"],["numBeams","U2"],["numValid","U2"],["freq","F4"],["info","U1"],["spare01","U1"],["spare02","U1"],["spare03","U1"]]);static STRUCT_XYZ_BODY=new Map([["z","F4"],["y","F4"],["x","F4"],["windowLen","U2"],["QFac","U1"],["angAdj","I1"],["dInfo","U1"],["cInfo","I1"],["reflectivity","I2"]]);static STRUCT_XYZ_TAIL=new Map([["spare04","U1"],["etx","U1"],["checksum","U2"]]);parseDetail(){const t=this.parse(T.STRUCT_XYZ_HEAD,0);t.body=[];for(let e=0;e<t.numBeams;e++){const e=this.parse(T.STRUCT_XYZ_BODY);t.body.push(e)}const e=this.parse(T.STRUCT_XYZ_TAIL);return t.etx=e.etx,t.checksum=e.checksum,this.saveDetail(t),t}parseWithPosition(){if(!this.referencedPos)return!1;const t=[];return this.parsedDetail.body.forEach((e=>{const s=this.calcPosWithXYZ(e);t.push(s)})),t}calcPosWithXYZ(t){const e=this.referencedPos;if(!e)return!1;const a=e.getLatLng(),r=this.parsedDetail.heading/100,i=s.destination(a.lat,a.lng,r,t.x),n=s.destination(i.lat,i.lng,r+90,t.y);return n.z=t.z+this.parsedDetail.txTRDepth,n}}class m extends u{static STRUCT_DD_HEAD=new Map([["length","U4"],["stx","U1"],["type","U1"],["model","U2"],["date","U4"],["time","U4"],["pingCounter","U2"],["serial","U2"],["heading","U2"],["ss","U2"],["txTRDepth","U2"],["maxNumBeams","U1"],["numValid","U1"],["zRes","U1"],["xyRes","U1"],["freq","U2"]]);static STRUCT_DD_BODY=new Map([["z","U2"],["y","I2"],["x","I2"],["beamDeprAng","I2"],["beamAzimAng","U2"],["range","U2"],["QFac","U1"],["len","U1"],["reflectivity","I1"],["beamNum","U1"]]);static STRUCT_DD_TAIL=new Map([["depthOffsetM","I1"],["etx","U1"],["checksum","U2"]]);parseDetail(){const t=this.parse(m.STRUCT_DD_HEAD,0);t.body=[];for(let e=0;e<t.numValid;e++){const e=this.parse(m.STRUCT_DD_BODY);t.body.push(e)}const e=this.parse(m.STRUCT_DD_TAIL);return t.etx=e.etx,t.checksum=e.checksum,this.saveDetail(t),t}parseWithPosition(){if(!this.referencedPos)return!1;const t=[];return this.parsedDetail.body.forEach((e=>{const s=this.calcPosWithXYZ(e);t.push(s)})),t}calcPosWithXYZ(t){const e=this.referencedPos;if(!e)return!1;const a=e.getLatLng(),r=this.parsedDetail.heading/100,i=s.destination(a.lat,a.lng,r,t.x/100),n=s.destination(i.lat,i.lng,r+90,t.y/100);return n.z=t.z/100+this.parsedDetail.txTRDepth,n}}class U extends u{static BYTE_LENGTH=4;static DATAGRAM_TYPES={73:{title:"Install Start",cls:f},105:{title:"Install Stop",cls:f},112:{title:"Install Remote",cls:f},82:{title:"Runtime",cls:g},88:{title:"XYZ88",cls:T},75:{title:"Central Beams",cls:null},70:{title:"Raw range and Beam angle",cls:null},102:{title:"Raw range and Beam angle F",cls:null},78:{title:"Raw range and angle 78",cls:null},83:{title:"Seabed image",cls:null},89:{title:"Seabed image 89",cls:null},107:{title:"Water column",cls:null},79:{title:"Quality factor 79",cls:null},65:{title:"Attitude",cls:null},110:{title:"Network attitude velocity",cls:null},67:{title:"Clock",cls:null},104:{title:"Depth or height",cls:null},72:{title:"Heading",cls:null},80:{title:"Position",cls:D},69:{title:"Single beam echo sounder depth",cls:null},84:{title:"Tide",cls:null},71:{title:"Surface sound speed",cls:null},85:{title:"Sound speed profile",cls:null},87:{title:"Kongberg Maritime SSP output",cls:null},74:{title:"Mechanical transducer tilt",cls:null},51:{title:"Extra parameters 3",cls:null},48:{title:"PU ID output",cls:null},49:{title:"PU Status output",cls:null},66:{title:"PU BIST result output",cls:null},68:{title:"Depth datagram",cls:m}};static STRUCT_TAIL=new Map([["etx","U1"],["checksum","U2"]]);static BYTE_STRUCT_TAIL=3;static getTailOffset(t){return t+U.BYTE_LENGTH-U.BYTE_STRUCT_TAIL}constructor(t,e,s){super(t,e,s),this.setLittleEndian(!0),this.parseOffset=0,this.parsedObj=void 0}static getTypeTitle(t){const e=U.getType(t);return!!e&&e.title}static getType(t){return!!U.DATAGRAM_TYPES.hasOwnProperty(t)&&U.DATAGRAM_TYPES[t]}parseBrief(t){const e=new Map([["length","U4"],["stx","U1"],["type","U1"]]),s=this.parse(e,t);return s.typeTitle=U.getTypeTitle(s.type),this.saveBrief(s),s}batchSplitDataGrams(){let t=0,e=0;const s={invalid:{}};for(;t<this.byteLength;){const a=this.parseBrief(t);U.getType(a.type);!1===a.typeTitle?(s.invalid[a.type]||(s.invalid[a.type]=0),s.invalid[a.type]++):s[a.typeTitle]?s[a.typeTitle]++:s[a.typeTitle]=1,t=t+a.length+U.BYTE_LENGTH,e++}return{type:s,count:e}}}class S extends r{}class E extends S{static STRUCT_BINARY_HEADER3200=new Map([["jobIDNum","U4"],["lineNum","U4"],["reelNum","U4"],["tracesPEns","U2"],["auxTracesPEns","U2"],["interval","U2"],["intervalOrg","U2"],["numSamplePTrace","U2"],["numSamplePTraceOrg","U2"],["code","U2"],["ensFold","U2"],["traceSortingCode","U2"],["vertSumCode","U2"],["sweepFreqStart","U2"],["sweepFreqEnd","U2"],["sweepLen","U2"],["sweepTypeCode","U2"],["traceNumSweepChannel","U2"],["sweepTTLenStart","U2"],["sweepTTLenEnd","U2"],["taperType","U2"],["corelTrace","U2"],["binGainRec","U2"],["ampRecM","U2"],["measureSystem","U2"],["impulseSigPol","U2"],["vibPolCode","U2"],["extNumTracePEns","U4"],["extNumAuxTracePEns","U4"],["extInterval","F8"],["extIntervalOrG","F8"],["extNumSamplePTraceOrg","U4"],["extEnsFold","U4"],["constant1234","U4"]]);static STRUCT_BINARY_HEADER3500=new Map([["majorRev","U1"],["minorRev","U1"],["fixedLenTrace","U2"],["numExtTextHDR","U2"],["numAddTraceHDR","U4"],["timeCode","U2"],["numTraceInFile","U8"],["offsetTrace","U8"],["numTrailerStanza","I4"]]);static STRUCT_TRACE_HEADER=new Map([["traceSeqLine","U4"],["traceSeqFile","U4"],["orgFieldRecNum","U4"],["traceNumOrg","U4"],["energySrc","U4"],["ensNum","U4"],["traceNumEns","U4"],["traceIDCode","U2"],["numVertSum","U2"],["numHoriSum","U2"],["dataUse","U2"],["distCent","U4"],["elevRecv","U4"],["surfElev","U4"],["srcDepth","U4"],["seisDatumRecv","U4"],["seisDatumSrc","U4"],["watColHeiSrc","U4"],["watColHeiRecv","U4"],["scalarElev","I2"],["scalarCoord","I2"],["srcCoordX","I4"],["srcCoordY","I4"],["grpCoordX","I4"],["grpCoordY","I4"],["coordUnit","U2"],["weatherVel","U2"],["subWeatherVel","U2"],["upSrcMS","U2"],["upGrpMS","U2"],["srcCorrMS","U2"],["grpCorrMS","U2"],["totMS","U2"],["lagAMS","U2"],["lagBMS","U2"],["delayRecMS","U2"],["muiteStartMS","U2"],["muiteEndMS","U2"],["numSample","U2"],["intervalSample","U2"],["gainType","U2"],["instGain","U2"],["instInitGain","U2"],["correlated","U2"],["sweepFreqS","U2"],["sweepFreqE","U2"],["sweepLen","U2"],["sweepType","U2"],["sweepTraceLenS","U2"],["sweepTraceLenE","U2"],["taperType","U2"],["aliasFFreq","U2"],["aliasFSlope","U2"],["notchFFreq","U2"],["notchFSlope","U2"],["lcFreq","U2"],["hcFreq","U2"],["lcSlope","U2"],["hcSlope","U2"],["year","U2"],["day","U2"],["hour","U2"],["minute","U2"],["second","U2"],["timeCode","U2"],["traceWeiFac","U2"],["geoGNRoll","U2"],["geoGNTrace","U2"],["geoGNLTrace","U2"],["gapSize","U2"],["overTravel","U2"],["XcoordEns","U4"],["YcoordEns","U4"],["PSinline","U4"],["PScrossline","U4"],["shotpoint","U4"],["scalarShot","U2"],["traceUnit","I2"],["transC","U8"],["transUnit","I2"],["id","U2"],["scalarTimes","U2"],["srcType","I2"],["srcEnergyDir","U2"],["sourceM1","U4"],["sourceM2","U2"],["srcUnit","I2"]]);static SAMPLE_FORMAT_CODE={IBM_FP_4:1,TWO_COMPLEMENT_INT_4:2,TWO_COMPLEMENT_INT_2:3,FIXED_POINT_GAIN_4:4,IEEE_FP_4:5,IEEE_FP_8:6,TWO_COMPLEMENT_INT_3:7,TWO_COMPLEMENT_INT_1:8,TWO_COMPLEMENT_INT_8:9,UINT_4:10,UINT_2:11,UINT_8:12,UINT_3:15,UINT_1:16};static DATE_TIME_CODE={1:"Local",2:"GMT",3:"Other",4:"UTC",5:"GPS"};static SOA2Degree(t){return t/3600}parseDetail(){this.setLittleEndian(!1);const t=this.parse(E.STRUCT_BINARY_HEADER3200,3200),e=this.parse(E.STRUCT_BINARY_HEADER3500,3500);Object.keys(e).forEach(((e,s)=>t[e]=s)),this.saveBrief(t),this.setParseOffset(3600);const s=[];if(E.SAMPLE_FORMAT_CODE.IBM_FP_4===t.code||E.SAMPLE_FORMAT_CODE.IEEE_FP_4===t.code){for(this.setLittleEndian(!1);this.parseOffset<this.byteLength;){const t=this.parseTraceOne();s.push(t)}return{binHeader:t,traces:s}}alert("Only 32bit floating point implemented, please report")}parseTraceOne(){const t=this.parse(E.STRUCT_TRACE_HEADER),e={},s=new Date;if(s.setUTCFullYear(t.year),s.setUTCMonth(0),s.setUTCDate(t.day),s.setUTCHours(t.hour),s.setUTCMinutes(t.minute),s.setUTCSeconds(t.second),s.setUTCMilliseconds(0),e.date=s,e.dateBase=E.DATE_TIME_CODE[t.timeCode],2===t.coordUnit){const s=t.srcCoordX/36e5,a=t.srcCoordY/36e5;e.srcPos=[a,s]}this.addParseOffset(10);const a=[];for(let e=0;e<t.numSample;e++){const t=this.getFloat32(this.parseOffset);a.push(t),this.parseOffset=this.parseOffset+4}return{header:t,parsedHeader:e,data:a}}getPrettyPrintBinHeader(){const t=this.getBrief();if(!t)return"Not yet parsed, or invalid";return[`Major: ${t.majorRev}, Minor: ${t.minorRev}`,`Data format code: ${t.code} - ${this.getCodeStr(t.code)}`,`Sample per trace: ${t.numSamplePTrace}`,`Interval: ${t.interval}us`].join("\n")}getCodeStr(t){let e="";return Object.keys(E.SAMPLE_FORMAT_CODE).forEach((s=>{E.SAMPLE_FORMAT_CODE[s]===t&&(e=s)})),e}}class I extends r{static parseDateTime(t){return new Date(Number((t-116444736000000000n)/10000n))}parseBrief(t){const e=new Map([["length","U4"]]),s=this.parse(e,t),a=this.toAsciiString(this.parseOffset,this.parseOffset+4);s.title=a;const r=this.getBigInt64(this.parseOffset+4);s.dateTime=r,s.date=I.parseDateTime(r),this.addParseOffset(s.length);return this.parse(e,this.parseOffset).length!==s.length&&console.error(`Start and end length is different at ${t}`),this.saveBrief(s),s}getLengthBody(){return this.getBrief().length-A.BYTE_BRIEF+A.BYTE_LENGTH_END}}class P extends I{parseDetail(){if(!this.getBrief())return"Can not parse detail if no brief";this.setParseOffset(A.BYTE_BRIEF);const t={xmlStr:this.toAsciiString(this.parseOffset,this.parseOffset+this.getLengthBody())};this.saveDetail(t)}}class M extends I{static BYTE_CHANNEL_ID=128;static STRUCT_RAW3=new Map([["dataTypeValue","U2"],["spare","U2"],["offset","I4"],["count","I4"]]);static BIT_DATA_TYPE={POWER:1,ANGLE:2,COMPLEX_FLOAT16:4,COMPLEX_FLOAT32:8,NUMBER_COMPLEX:1792};parseDetail(){if(!this.getBrief())return"Can not parse detail if no brief";if(this.getDetail())return;this.setParseOffset(A.BYTE_BRIEF);const t=this.toAsciiString(this.parseOffset,this.parseOffset+M.BYTE_CHANNEL_ID);this.addParseOffset(M.BYTE_CHANNEL_ID);const e=this.parse(M.STRUCT_RAW3,this.parseOffset);e.channelId=t.replace(/^\s*/,"").replace(/\s*$/,"").replace(/\u0000*$/,"");const s=e.dataTypeValue&M.BIT_DATA_TYPE.POWER,a=e.dataTypeValue&M.BIT_DATA_TYPE.ANGLE,r=e.dataTypeValue&M.BIT_DATA_TYPE.COMPLEX_FLOAT16,i=e.dataTypeValue&M.BIT_DATA_TYPE.COMPLEX_FLOAT32,n=(e.dataTypeValue&M.BIT_DATA_TYPE.NUMBER_COMPLEX)>>8;e.dataType={power:!!s,angle:!!a,f16:!!r,f32:!!i,number:n},this.saveDetail(e)}getValues(){const t=this.getDetail();if(!t)return console.error("Can not get value if no detail"),!1;if(t.dataType.f16)console.error("Float 16 type is not supported");else if(t.dataType.f32){const e=[],s=this.parseOffset+t.offset;for(let a=0;a<t.count*(2*t.dataType.number);a++){const t=this.getFloat32(s+4*a);e.push(t)}return e}return!1}}class A extends I{static BYTE_LENGTH_START=4;static BYTE_LENGTH_END=4;static BYTE_LENGTH=A.BYTE_LENGTH_START+A.BYTE_LENGTH_END;static BYTE_DATE=8;static BYTE_TITLE=4;static BYTE_BRIEF=A.BYTE_LENGTH_START+A.BYTE_TITLE+A.BYTE_DATE;static TYPE_RAW3="RAW3";static TYPE_XML0="XML0";static TYPE_NME0="NME0";static TYPE_MRU0="MRU0";static TYPE_FIL1="FIL1";static mapCls={XML0:{title:"XML",cls:P},RAW3:{title:"Raw",cls:M},NME0:{title:"NMEA"},MRU0:{title:"MRU"},FIL1:{title:"Filter"}};constructor(t,e,s){super(t,e,s),this.setLittleEndian(!0),this.parseOffset=0}batchSplitDataGrams(){let t=0,e=0;const s={invalid:{},channelIds:{},RAW3:0,XML0:0,NME0:0,MRU0:0,FIL1:0},a=[];for(;t<this.byteLength;){const r=this.parseBrief(t),i=A.mapCls[r.title];if(s.hasOwnProperty(r.title)?s[r.title]++:s.invalid.hasOwnProperty(r.title)?s.invalid[r.title]++:s.invalid[r.title]=1,i&&i.cls){const e=new i.cls(this.buffer,t,r.length+A.BYTE_LENGTH);if(e.setLittleEndian(this.littleEndian),e.parseBrief(),e.parseDetail(),"RAW3"===r.title){const t=e.getDetail().channelId;s.channelIds.hasOwnProperty(t)?s.channelIds[t]++:s.channelIds[t]=1}a.push(e)}t=t+r.length+A.BYTE_LENGTH,e++}s.i=e;return{counts:s,results:a}}}class v extends r{constructor(t,e,s){super(t,e,s),this.setLittleEndian(!0)}parseBrief(){const t=new y(this.buffer,this.byteOffset,this.byteLength);t.parseDetail(),this.saveBrief(t.parsedDetail)}parseDetail(){if(this.parsedDetail=[],!this.parsedBrief)return console.error("PD0 has no parsedBrief, can not proceed to parse"),!1;for(let t=0;t<this.parsedBrief.offsets.length;t++){const e=this.parsedBrief.offsets[t];if(!e.obj)continue;if(!e.obj.cls)continue;const s=new e.obj.cls(this.buffer,this.byteOffset+e.offsetRel,e.size);s.setLittleEndian(this.littleEndian),s.parseDetail(),s.title=e.obj.title,this.parsedDetail.push(s)}}parseVelocity2D(){const t=this.getByHID(V.HID.FIXED),e=this.getByHID(V.HID.VELOCITY),s=this.getByHID(V.HID.NAV);e.parseVelocity2D(t.parsedDetail.coordParsed.type);e.parseMDNav(s.parsedDetail.SMG,s.parsedDetail.parsed.DMG)}getByHID(t){if("object"!=typeof t)return!1;if(!this.getDetail())return!1;const e=t.code;return this.getDetail().find((t=>e===t.getDetail().hID))}getTimestamp(){const t=this.getByHID(V.HID.VARIABLE);return!!t&&t.getTimestamp()}}class y extends v{static HEADER=new Map([["hID","U1"],["srcID","U1"],["noBytesEns","U2"],["spare01","U1"],["noDataTypes","U1"]]);parseDetail(){const t=this;this.setParseOffset(0);const e=this.parse(y.HEADER),s=[];for(let t=0;t<e.noDataTypes;t++){const t=this.getUint16(this.parseOffset);s.push({offsetRel:t}),this.addParseOffset(2)}let a;e.offsets=s,s.forEach((s=>{if(s.size=e.noBytesEns+2-s.offsetRel,a){const t=s.offsetRel-a.offsetRel;a.size=t}a=s;const r=t.getUint16(s.offsetRel),i=V.JudgetHID(r);i||console.error(`Invalid HID 0x${r.toString(16)}`),s.obj=i})),this.saveDetail(e)}}class C extends v{static FIXED_LEADER=new Map([["hID","U2"],["fwVer","U1"],["fwRev","U1"],["sysCfg","U2"],["flagSim","U1"],["lagLen","U1"],["noBeams","U1"],["noCells","U1"],["pingsPEns","U2"],["dptCellLen","U2"],["blankTrans","U2"],["profMode","U1"],["lowCorrThresh","U1"],["noCodeReps","U1"],["PGMin","U1"],["EVMax","U2"],["TPPm","U1"],["TPPs","U1"],["TPPHund","U1"],["coordTransf","U1"],["hdtAli","U2"],["hdtBias","U2"],["sensorSrc","U1"],["sensorsAvail","U1"],["bin1Dist","U2"],["xmitPulseLen","U2"],["WPRefAvg","U2"],["falseTgtThresh","U1"],["spare02","U1"],["transLagDist","U2"],["cpuSerial","U8"],["sysBandwidth","U2"],["sysPwr","U1"],["spare03","U1"],["insSerial","U4"],["beamAngle","U1"]]);static SYSTEM=[[0,"75kHz"],[1,"150kHz"],[2,"300kHz"],[3,"600kHz"],[4,"1200kHz"],[5,"2400kHz"],[6,"38kHz"]];static COORD=[[0,"No transformation"],[8,"Instrument coordinates"],[16,"Ship coordinates"],[24,"Earth coordinate"]];static SENSOR_SRC=[[64,"Calculates EC (Speed of sound) from ED, ES, ET"],[32,"Uses ED from depth sensor"],[16,"Uses EH from transducer heading sensor"],[8,"Uses EP from transducer pitch sensor"],[4,"Uses ER from transducer roll sensor"],[2,"Uses ES (Salinity) from transducer conductivity sensor"],[1,"Uses ET from transducer temperature sensor"]];static ParseCoordTransform(t){const e=24&t,s=4&t,a=2&t,r=1&t,i=C.COORD.find((t=>t[0]===e)),n=i?i[1]:v.UNHANDLED_STR+` value : ${e}`,o=0<s,l=0<a,c=0<r;return{type:e,typeStr:n,tilt:o,tiltStr:o?"Tilt pitch roll used":"Tilt pitch roll not used",beam3:l,beam3Str:l?"3-Beam solution used":"3-Beam solution not used",binMapping:c,binMappingStr:c?"Bin mapping used":"Bin mapping not used"}}static ParseSysConfig(t){const e=255&t,s=(65280&t)>>8,a=7&e,r=8&e,i=48&e,n=64&e,o=128&e,l=C.SYSTEM.find((t=>t[0]===a)),c=l?l[1]:v.UNHANDLED_STR+` value : ${a.toString(2)}`,h=0<r?"CONVEX BEAM PAT":"CONCAVE BEAM PAT";let p=v.UNHANDLED_STR;0===i?p="Sensor Config 1":16===i?p="Sensor Config 2":32===i&&(p="Sensor Config 3");const d=0<n?"XDCR HD Attached":"XDCR HD Not Attached",u=0<o?"Up Facing beam":"Down Facing beam",f=3&s,g=240&s;let D=v.UNHANDLED_STR+` value : ${f.toString(2)}`,T=v.UNHANDLED_STR+` value : ${g.toString(2)}`;0===f?D="15E Beam Angle":1===f?D="20E Beam Angle":2===f?D="30E Beam Angle":3===f&&(D="Other Beam Angle"),64===g?T="4-Beam JANUS Config":80===g?T="5-Beam JANUS Config DEMOD":240===g&&(T="5-Beam JANUS Config 2 DEMOD");return{systemStr:c,conBeamStr:h,sensorCfgStr:p,xdcrStr:d,beamFaceStr:u,beamAngleStr:D,janusStr:T}}static ParseSensorSrc(t){const e=[];return C.SENSOR_SRC.forEach((s=>{0<(s[0]&t)&&e.push(s[1])})),e}parseDetail(){const t=this.parse(C.FIXED_LEADER,0);if(V.HID.FIXED.code!==t.hID)return void console.error(`Invalid HID ${t.hID.toString(16)}`);const e=C.ParseSysConfig(t.sysCfg);t.sysCfgParsed=e;const s=C.ParseCoordTransform(t.coordTransf);t.coordParsed=s;const a=C.ParseSensorSrc(t.sensorSrc);t.sensorSrcParsed=a,t.hdtAli=.01*t.hdtAli,t.hdtBias=.01*t.hdtBias,this.saveDetail(t)}}class _ extends v{static VARIABLE_LEADER=new Map([["hID","U2"],["noEns","U2"],["tsYear","U1"],["tsMonth","U1"],["tsDay","U1"],["tsHour","U1"],["tsMin","U1"],["tsSec","U1"],["tsHundredths","U1"],["ensMSB","U1"],["bitResult","U2"],["soundSpeed","U2"],["dptTrans","U2"],["hdt","U2"],["pitch","I2"],["roll","I2"],["salinity","U2"],["temp","I2"],["mptMin","U1"],["mptSec","U1"],["mptHundredths","U1"],["stdHdt","U1"],["stdPitch","U1"],["stdRoll","U1"],["adc0","U1"],["adc1","U1"],["adc2","U1"],["adc3","U1"],["adc4","U1"],["adc5","U1"],["adc6","U1"],["adc7","U1"],["errStatus","U4"],["spare01","U2"],["pressure","U4"],["pressureVar","U4"],["spare02","U1"],["rtcCentury","U1"],["rtcYear","U1"]]);static BIT_RESULT_HI=[[16,"DEMOD 1 Error"],[8,"DEMOD 0 Error"],[2,"Timing card Error"]];static ERROR_STATUS1=[[1,"Bus error exception"],[2,"Address error exception"],[4,"Illegal Instruction exception"],[8,"Zero Divide exception"],[16,"Emulator exception"],[32,"Unassigned exception"],[64,"Watchdog restart occured"],[128,"Batter saver power"]];static ERROR_STATUS2=[[1,"Pinging"],[64,"Cold wakeup occurred"],[128,"Unknown wakeup occurred"]];static ERROR_STATUS3=[[1,"Clock read error occurred"],[2,"Unexpected alarm"],[4,"Clock jump forward"],[8,"Clock jump backward"]];static ERROR_STATUS4=[[8,"Power fail - unrecorded"],[16,"spurious level 4 intr - DSP"],[32,"spurious level 5 intr - UART"],[64,"spurious level 6 intr - CLOCK"],[128,"Level 7 interrupt occurred"]];static ParseBitResult(t){const e=t>>8,s=[];return _.BIT_RESULT_HI.forEach((t=>{0<(t[0]&e)&&s.push(t[1])})),s}static ParseErrorStatus(t){const e=255&t,s=(65280&t)>>8,a=(16711680&t)>>16,r=(4278190080&t)>>24,i=[];return _.ERROR_STATUS1.forEach((t=>{0<(t[0]&e)&&i.push(t[1])})),_.ERROR_STATUS2.forEach((t=>{0<(t[0]&s)&&i.push(t[1])})),_.ERROR_STATUS3.forEach((t=>{0<(t[0]&a)&&i.push(t[1])})),_.ERROR_STATUS4.forEach((t=>{0<(t[0]&r)&&i.push(t[1])})),i}static ParseDate(t,e,s,a,r,i,n){t+=t>80?1900:2e3,e-=1;const o=10*n;return new Date(Date.UTC(t,e,s,a,r,i,o))}parseDetail(){if(this.byteLength<this.calcLengthStruct(_.VARIABLE_LEADER))return void console.error(`Invalid length of PD0Variable, ${this.byteLength} < ${this.calcLengthStruct(_.VARIABLE_LEADER)}`);const t=this.parse(_.VARIABLE_LEADER,0);V.HID.VARIABLE.code===t.hID?(t.bitResultParsed=_.ParseBitResult(t.bitResult),t.hdt=.01*t.hdt,t.pitch=.01*t.pitch,t.roll=.01*t.roll,t.temp=.01*t.temp,t.stdPitch=.1*t.stdPitch,t.stdRoll=.1*t.stdRoll,t.errStatusParsed=_.ParseErrorStatus(t.errStatusParsed),this.saveDetail(t),t.tsStr=this.getTimestamp()):console.error(`Invalid HID ${t.hID.toString(16)}`)}getTimestamp(){if(!this.parsedDetail)return!1;const t=this.parsedDetail;return _.ParseDate(t.tsYear,t.tsMonth,t.tsDay,t.tsHour,t.tsMin,t.tsSec,t.tsHundredths)}}class x extends v{static SIZE_VELOCITY=8;static ParseVelocity2D(t,e){if(C.COORD[0][0]===t)return!1;if(C.COORD[3][0]===t){const t=x.XYMagDir(e[1],e[0]);return{magnitude:t[0],direction:t[1],e:e[0],n:e[1],sur:e[2],err:e[3]}}return!1}static XYMagDir(t,e){return[Math.sqrt(t*t+e*e),(360-Math.atan2(e,t)*(180/Math.PI)+90)%360]}static TrueWind(t,e,s,a){const r=s*s+t*t-2*s*t*Math.cos(e*Math.PI/180),i=Math.sqrt(r),n=(t*t-i*i-s*s)/(2*i*s);return[i,a+Math.acos(n)*(180/Math.PI)]}static DegreeToRange(t){if(t=Number(t),isNaN(t))return 0;for(;t<0;)t=360+t;return t%=360}parseDetail(){const t=this.getUint16(0);if(this.addParseOffset(2),V.HID.VELOCITY.code!==t)return void console.error(`Invalid HID for Velocity(${V.HID.VELOCITY.code.toString(16)}) != ${t.toString(16)}`);const e=[],s=(this.byteLength-2)/x.SIZE_VELOCITY;for(let t=0;t<s;t++){const t=this.parseArray("I2",4);e.push(t)}const a={hID:t,cells:e};this.saveDetail(a)}parseVelocity2D(t){const e=[];if(C.COORD[3][0]!==t)return!1;this.parsedDetail&&(this.parsedDetail.cells.forEach((t=>{V.INVALID_VALUE!==t[0]&&V.INVALID_VALUE!==t[1]&&V.INVALID_VALUE!==t[2]&&V.INVALID_VALUE!==t[3]?e.push(x.XYMagDir(t[0],t[1])):e.push([V.INVALID_VALUE,V.INVALID_VALUE])})),this.parsedDetail.md=e)}parseMDNav(t,e){if(!this.parsedDetail||!this.parsedDetail.md)return console.error("parseMDNav should be called after md has calculated"),!1;const s=[];this.parsedDetail.md.forEach((a=>{if(V.INVALID_VALUE===a[0]||V.INVALID_VALUE===a[1])return void s.push([V.INVALID_VALUE,V.INVALID_VALUE]);if(0===t)return void s.push(a);const r=x.DegreeToRange(a[1]+180-e),i=x.TrueWind(a[0],r,t,e);i[1]=(i[1]+180)%360,s.push(i)})),this.parsedDetail.mdNav=s}}class L extends v{static SIZE_CORR=4;parseDetail(){const t=this.getUint16(0);if(this.addParseOffset(2),V.HID.CORR.code!==t)return void console.error(`Invalid HID for Corr(${V.HID.CORR.code.toString(16)}) != ${t.toString(16)}`);const e=[],s=(this.byteLength-2)/L.SIZE_CORR;for(let t=0;t<s;t++){const t=this.parseArray("U1",4);e.push(t)}const a={hID:t,cells:e};this.saveDetail(a)}}class R extends v{static SIZE_INTENSITY=4;parseDetail(){const t=this.getUint16(0);if(this.addParseOffset(2),V.HID.INTENSITY.code!==t)return void console.error(`Invalid HID for Intensity(${V.HID.INTENSITY.code.toString(16)}) != ${t.toString(16)}`);const e=[],s=(this.byteLength-2)/R.SIZE_INTENSITY;for(let t=0;t<s;t++){const t=this.parseArray("U1",4);e.push(t)}const a={hID:t,cells:e};this.saveDetail(a)}}class b extends v{static SIZE_PG=4;parseDetail(){const t=this.getUint16(0);if(this.addParseOffset(2),V.HID.PG.code!==t)return void console.error(`Invalid HID for Percent Good(${V.HID.PG.code.toString(16)}) != ${t.toString(16)}`);const e=[],s=(this.byteLength-2)/b.SIZE_PG;for(let t=0;t<s;t++){const t=this.parseArray("U1",4);e.push(t)}const a={hID:t,cells:e};this.saveDetail(a)}}class O extends v{static SIZE_STATUS=4;parseDetail(){const t=this.getUint16(0);if(this.addParseOffset(2),V.HID.STATUS.code!==t)return void console.error(`Invalid HID for Status(${V.HID.STATUS.code.toString(16)}) != ${t.toString(16)}`);const e=[],s=(this.byteLength-2)/O.SIZE_STATUS;for(let t=0;t<s;t++){const t=this.parseArray("U1",4);e.push(t)}const a={hID:t,cells:e};this.saveDetail(a)}}class B extends v{static BT_DATA=new Map([["hID","U2"],["pingsPEns","U2"],["delayReacq","U2"],["corrMagMin","U1"],["evalAmpMin","U1"],["pgMin","U1"],["mode","U1"],["errVelMax","U2"],["reserved","U4"]]);static BT_LAYER_WORD=new Map([["min","U2"],["near","U2"],["far","U2"]]);parseDetail(){const t=this.parse(B.BT_DATA,0);if(V.HID.BT.code!==t.hID)return console.error(`Invalid HID for BottomTrack(${V.HID.BT.code.toString(16)}) != ${hID.toString(16)}`),!1;const e=this.parseArray("U2",4),s=this.parseArray("U2",4),a=this.parseArray("U1",4),r=this.parseArray("U1",4),i=this.parseArray("U1",4),n=this.parseArray("U1",4),o=this.parseArray("U2",4),l=this.parseArray("U1",4),c=this.parseArray("U1",4),h=this.parseArray("U1",4),p=this.getUint16(this.parseOffset);this.addParseOffset(2);let d=this.parseArray("U1",4),u=this.parseArray("U1",4);const f=d.map((t=>.45*t));u=u.map((t=>65536*t)),t.range=e,t.vel=s,t.corr=a,t.evalAmp=r,t.pg=i,t.refLayer=n,t.refLayerVel=o,t.refCorr=l,t.refInt=c,t.refPG=h,t.maxDepth=p,t.rssiAmp=d,t.rssiAmpDb=f,t.msbRange=u,this.saveDetail(t)}}class w extends v{parseDetail(){const t=this.getUint16(0);this.addParseOffset(2);const e=this.parseArray("U1",4);if(V.HID.ASP.code!==t)return void console.error(`Invalid HID for Ambient Sound Profile(${V.HID.PG.code.toString(16)}) != ${t.toString(16)}`);const s={hID:t,rssi:e};this.saveDetail(s)}}class F extends v{static NAV_DATA=new Map([["hID","U2"],["utcDay","U1"],["utcMonth","U1"],["utcYear","U2"],["utcTimeFF","I4"],["pcClockOffset","I4"],["firstLat","U4"],["firstLng","U4"],["utcTimeLF","U4"],["lastLat","U4"],["lastLng","U4"],["avgSpd","I2"],["avgTrackTrue","U2"],["avgTrackMag","U2"],["SMG","U2"],["DMG","U2"],["reserved1","U2"],["flags","U2"],["reserved2","U2"],["noEns","U4"],["ensYear","U2"],["ensDay","U1"],["ensMonth","U1"],["ensTime","U4"],["pitch","I2"],["roll","I2"],["hdt","U2"],["numSpeedAvg","U2"],["numTTAvg","U2"],["numMTAvg","U2"],["numHdtAvg","U2"],["numPRAvg","U2"]]);static BAM(t,e){return 180*t/Math.pow(2,e-1)}static parseNavFlags(t){const e=[],s=[];return 0==(1&t)&&e.push("Data not updated"),0==(2&t)&&e.push("PSN Invalid"),0==(4&t)&&e.push("Speed Invalid"),0==(8&t)&&e.push("Mag Track Invalid"),0==(16&t)&&e.push("True Track Invalid"),0==(32&t)&&e.push("Date/Time Invalid"),0==(64&t)&&e.push("SMG/DMG Invalid"),0==(128&t)&&e.push("Pitch/Roll Invalid"),0==(256&t)&&e.push("Heading Invalid"),0==(512&t)&&e.push("ADCP Time Invalid"),0==(1024&t)&&e.push("Clock offset Time Invalid"),0!=(1&t)&&s.push("Data updated"),0!=(2&t)&&s.push("PSN Valid"),0!=(4&t)&&s.push("Speed Valid"),0!=(8&t)&&s.push("Mag Track Valid"),0!=(16&t)&&s.push("True Track Valid"),0!=(32&t)&&s.push("Date/Time Valid"),0!=(64&t)&&s.push("SMG/DMG Valid"),0!=(128&t)&&s.push("Pitch/Roll Valid"),0!=(256&t)&&s.push("Heading Valid"),0!=(512&t)&&s.push("ADCP Time Valid"),0!=(1024&t)&&s.push("Clock offset Time Valid"),{invalid:e,valid:s}}parseDetail(){const t=this.parse(F.NAV_DATA,0);if(V.HID.NAV.code!==t.hID)return console.error(`Invalid HID for Navigation(${V.HID.NAV.code.toString(16)}) != ${hID.toString(16)}`),!1;const e={},s=t.utcTimeFF/10,a=t.utcTimeLF/10,r=new Date;r.setUTCFullYear(t.utcYear,t.utcMonth-1,t.utcDay),r.setUTCMilliseconds(s);const i=new Date;i.setUTCFullYear(t.utcYear,t.utcMonth-1,t.utcDay),i.setUTCMilliseconds(a),e.utcFF=r,e.utcLF=i;const n=new Date;n.setUTCFullYear(t.ensYear,t.ensMonth-1,t.ensDay),n.setUTCMilliseconds(t.ensTime/100),e.ensDate=n,e.ensDateNote="Not verified if its utc or local based time",e.lastPos=[F.BAM(t.lastLat,32),F.BAM(t.lastLng,32)],e.firstPos=[F.BAM(t.firstLat,32),F.BAM(t.firstLng,32)],e.avgTrackTrue=F.BAM(t.avgTrackTrue,16),e.avgTrackMag=F.BAM(t.avgTrackMag,16),e.DMG=F.BAM(t.DMG,16);const o=F.parseNavFlags(t.flags);e.flagsInvalid=o.invalid,e.flagsValid=o.valid,e.hdt=F.BAM(t.hdt,16),e.pitch=F.BAM(t.pitch,16),e.roll=F.BAM(t.roll,16),t.parsed=e,this.saveDetail(t)}}class N extends v{static BINFIXED_ATTITUDE_DATA=new Map([["EF","U1"],["EH","U2"],["EI","U2"],["EJ","U2"],["EP","U4"],["EU","U1"],["EV","U2"],["EZ","U8"]]);parseDetail(){const t=this.getUint16(0);if(this.addParseOffset(2),V.HID.BINFIXED_ATTITUDE.code!==t)return void console.error(`Invalid HID for Binary Fixed Attitude(${V.HID.BINFIXED_ATTITUDE.code.toString(16)}) != ${t.toString(16)}`);const e=this.toAsciiString(2,9);this.addParseOffset(8);const s=this.parse(N.BINFIXED_ATTITUDE_DATA);s.hID=t,s.EE=e,this.saveDetail(s)}}class H extends v{parseDetail(){const t=this.getUint16(0);this.addParseOffset(2);const e=[];for(let t=1;t<=8;t++){const t=this.parseArray("U2",6);e.push(t)}const s={hID:t,types:e};this.saveDetail(s)}}class V extends r{static HEADER_HID=32639;static UNHANDLED_STR="Unhandled string";static INVALID_VALUE=-32768;static HID_BINVAR_ATTITUDE=[12352,12540];static HID={FIXED:{code:0,title:"Fixed Leader",cls:C},VARIABLE:{code:128,title:"Variable Leader",cls:_},VELOCITY:{code:256,title:"Veolocity Data",cls:x},CORR:{code:512,title:"Correlation magnitude Data",cls:L},INTENSITY:{code:768,title:"Echo intensity Data",cls:R},PG:{code:1024,title:"Percent good Data",cls:b},STATUS:{code:1280,title:"Status Data",cls:O},BT:{code:1536,title:"Bottom Track Data",cls:B},ASP:{code:524,title:"Ambient Sound Profile",cls:w},MICROCAT:{code:2048,title:"MicroCAT Data"},NAV:{code:8192,title:"Binary Navigation Data",cls:F},BINFIXED_ATTITUDE:{code:12288,title:"Binary Fixed Attitude Data",cls:N},BINVAR_ATTITUDE:{code:12352,title:"Binary Variable Attitude data",cls:H},UNKNOWN30E8:{code:12520,title:"Unknown type 0x30E8"},UNKNOWN30D8:{code:12504,title:"Unknown type 0x03D8"}};static JudgetHID(t){for(const[e,s]of Object.entries(V.HID))if(s.code===t)return s;if(t>=V.HID_BINVAR_ATTITUDE[0]&&t<=V.HID_BINVAR_ATTITUDE[1])return V.HID.BINVAR_ATTITUDE}constructor(t,e,s){super(t,e,s),this.setLittleEndian(!0),this.parseOffset=0}parseBrief(t){const e=this;this.setParseOffset(t);const s=this.buffer.byteLength,a=[],r=[0];for(;this.parseOffset<s;){if(!this.test7F(this.parseOffset))return!1;const t=this.parsePD0Size(this.parseOffset);this.addParseOffset(t),r.push(this.parseOffset)}let i=0;r.forEach((t=>{if(i<t){const s=new v(e.buffer,i,t-i);a.push(s)}i=t})),this.saveBrief(a)}test7F(t){const e=this.getUint16(t);return V.HEADER_HID===e||(console.error(`Invalid Head ID, 0x${e.toString(16)} != 0x${V.HEADER_HID.toString(16)}`),!1)}parsePD0Size(t){const e=t+2;return this.getUint16(e)+2}batch20210527(){this.parseBrief(0),console.time();for(let t=0;t<this.parsedBrief.length;t++){const e=this.parsedBrief[t];e.parseBrief(),e.parseDetail(),e.parseVelocity2D()}console.timeEnd()}debug20210601(){const t=this.getBrief();for(let e=0;e<50;e++){const s=t[e].getTimestamp();console.log(s)}}}class Y{constructor(t){this.ignoreCount=0,t&&this.setDataSource(t),this.result=[]}setDataSource(t){this.dataSource=t,this.lines=this.dataSource.split("\n")}setIgnore(t){if(t<=0)return console.error(`setIgnore invalid count ${t}`),!1;this.ignoreCount=t-1}parseBrief(){return console.error("Implement this, result only"),this.result}parseDetail(){console.error("Optional Implement, result with original line")}getResult(){return this.result}getTitle(){return"TXTCSV Parent"}static objToCommas(t){const e=[];return Object.keys(t).forEach((s=>{const a=t[s];e.push(`${s} = '${a}'`)})),e.join(",")}static try(t){return!1}static ParseMap(t,e){if("object"!=typeof e)return!1;if(e.assert&&(e.assert.hasOwnProperty("failure")||(e.assert.failure=!1),e.assert.has)){const s=typeof e.assert.has;if("object"===s){if(-1===e.assert.has.findIndex((e=>-1!==t.indexOf(e))))return e.assert.failure}else if("string"===s&&-1===t.indexOf(e.assert.has))return e.assert.failure}const s=t.split(",");if(e.assert&&e.assert.count&&s.length!==e.assert.count)return e.assert.failure;const a={};return Object.keys(e.pair).forEach((t=>{const r=e.pair[t];a[r]=s[t]})),e.post&&Object.keys(e.post).forEach((t=>{const s=e.post[t],r=e.pair[t];a[r]=s(a[r])})),a}}class G extends Y{static MapEA600DPT={getTitle:()=>"MapEA600DPT",assert:{count:3},pair:{1:"dpt"},post:{1:parseFloat}};static MapEM122DPT={getTitle:()=>"MapEM122DPT",assert:{count:4},pair:{1:"dpt",2:"base"},post:{1:parseFloat,2:parseFloat}};static MapWinch={getTitle:()=>"MapWinch",assert:{has:"@RCWDM",count:9,failure:!1},pair:{1:"no",3:"length",5:"speed",8:"blockT"},post:{1:parseInt,3:parseFloat,5:parseFloat,8:parseFloat}};static MapFluke1620A={getTitle:()=>"MapFluke1620A",assert:{count:4},pair:{0:"t1",1:"h1",2:"t2",3:"h2"},post:{0:parseFloat,1:parseFloat,2:parseFloat,3:parseFloat}};static MapWeather={getTitle:()=>"MapWeather",assert:{count:29},pair:{0:"timestamp",1:"lat",2:"lon",3:"ws",4:"wd",5:"ws_gust",6:"wd_gust",7:"ws_true",8:"wd_true",9:"ws_gust_true",10:"wd_gust_true",11:"tem",12:"hum",13:"pre",14:"rain_hour",15:"rain_day",16:"pyr",17:"uv",18:"pyrge",19:"quan",20:"nr",21:"lpc",22:"heading",23:"roll",24:"pitch",25:"course",26:"horizontal_speed",27:"panel_temp",28:"batt_volt"},post:{3:parseFloat,4:parseFloat,5:parseFloat,6:parseFloat,7:parseFloat,8:parseFloat,9:parseFloat,10:parseFloat,11:parseFloat,12:parseFloat,13:parseFloat,14:parseFloat,15:parseFloat,22:parseFloat,23:parseFloat,24:parseFloat,25:parseFloat,26:parseFloat,27:parseFloat,28:parseFloat}};static MapHIPAP={getTitle:()=>"MapHIPAP",assert:{has:"$PSIMSSB",count:17,failure:!1},pair:{1:"timestamp",2:"id",8:"lat",9:"latD",10:"lng",11:"lngD",12:"depth"},post:{1:parseFloat,8:parseFloat,10:parseFloat,12:parseFloat}};static MapCTD={getTitle:()=>"MapCTD",assert:{count:7,failure:!1},pair:{0:"depth",1:"altimeter",2:"temp",3:"sal",4:"oxygen",5:"par",6:"fluore"},post:{0:parseFloat,1:parseFloat,2:parseFloat,3:parseFloat,4:parseFloat,5:parseFloat,6:parseFloat}};setDefaultMap(t){this.defaultMap=t}parseBrief(){if(!this.defaultMap)return!1;for(let t=0;t<this.lines.length;t++){const e=this.lines[t];this.result.push(Y.ParseMap(e,this.defaultMap))}return this.result}parseDetail(){if(!this.defaultMap)return!1}getResult(){}}class X extends Y{constructor(t){super(t)}static try(t){return X.ParseSeapathLine(t)}static MapVTG={assert:{count:10},pair:{1:"course",5:"speed"},post:{1:parseFloat,5:parseFloat}};static MapHDT={assert:{count:3},pair:{1:"hdt"},post:{1:parseFloat}};static MapPSXN={assert:{count:6,has:"$PSXN"},pair:{1:"variable",2:"roll",3:"pitch",4:"heading",5:"heave"},post:{2:parseFloat,3:parseFloat,4:parseFloat,5:parseFloat}};static ParseSeapathZDA(t){const e=t.split(","),s=e[1].substr(0,2),a=e[1].substr(2,2),r=e[1].substr(4,2),i=e[1].substr(7),n=`${e[4]}-${e[3]}-${e[2]} ${s}:${a}:${r}.${i}Z`,o=`${e[4]}-${e[3]}-${e[2]} ${s}:${a}:${r}`;return{date:new Date(n),dateTrim:new Date(o)}}static ParseSeapathGGA(t){const e={},s=t.split(",");if(15!==s.length)return{};const a=s[2].match(/(\d+)(\d\d)\.(.*)/);if(a){const t=parseFloat(a[2]+"."+a[3])/60;e.lat=parseInt(a[1])+t,"S"===s[3]&&(e.lat=-1*e.lat),e.latStr=`${s[2]},${s[3]}`}var r=s[4].match(/(\d+)(\d\d)\.(.*)/);if(r){var i=parseFloat(r[2]+"."+r[3])/60;e.lng=parseInt(r[1])+i,"W"===s[5]&&(e.lng=-1*e.lng),e.lngStr=`${s[4]},${s[5]}`}return e}static ParseSeapathGroup(t){const e=t.split("\n"),s={};return e.forEach((t=>{-1!==t.indexOf("ZDA,")?s.zda=X.ParseSeapathZDA(t):-1!==t.indexOf("GGA,")?s.gga=X.ParseSeapathGGA(t):-1!==t.indexOf("VTG,")?s.vtg=Y.ParseMap(t,X.MapVTG):-1!==t.indexOf("HDT,")?s.hdt=Y.ParseMap(t,X.MapHDT):-1!==t.indexOf("PSXN,")&&(s.psxn=Y.ParseMap(t,X.MapPSXN))})),s}static ParseSeapathLine(t,e){return e||(e={}),-1!==t.indexOf("ZDA,")?e.zda=X.ParseSeapathZDA(t):-1!==t.indexOf("GGA,")?e.gga=X.ParseSeapathGGA(t):-1!==t.indexOf("VTG,")?e.vtg=Y.ParseMap(t,X.MapVTG):-1!==t.indexOf("HDT,")?e.hdt=Y.ParseMap(t,X.MapHDT):-1!==t.indexOf("PSXN,")&&(e.psxn=Y.ParseMap(t,X.MapPSXN)),e}static getTitle(){return"Seapath"}parseBrief(){const t=[];let e={},s=0;for(let a=0;a<this.lines.length;a++){const r=this.lines[a];if(!(5>=r.length)){if(-1!==r.indexOf("GGA,")){if(0<=s)s--;else if(0>s){s=this.ignoreCount;continue}e.gga&&(t.push(e),e={})}0<=s||X.ParseSeapathLine(r,e)}}return 0<Object.keys(e).length&&t.push(e),this.result=t,this.result}}class $ extends Y{static ParsePCO2(t){const e=t.split("\t");if(42!==e.length)return!1;const s={};return["Type","error","PC_Date","PC_Time","GPS_date","gps_time","latitude","longitude","equ_temp","std_val","CO2a_W","CO2b_W","CO2_um/m","H2Oa_W","H2Ob_W","H2O_mm","licor_temp","licor_press","atm_press","equ_press","H2O_flow","licor_flow","equ_pump","vent_flow","atm_cond","equ_cond","drip_1","drip_2","cond_temp","dry_box_temp","deck_box_temp","Press","Temp","Cond","Sal","O2","O2ppm","pH","Temp2","Chl","Turb","TSG38"].forEach(((t,a)=>{s[t]=e[a],a>7&&(s[t]=parseFloat(s[t]))})),s}static try(t){return $.ParsePCO2(t)}static getTitle(){return"PCO2"}}class z{static ListParsers=[G.MapCTD,G.MapEA600DPT,G.MapFluke1620A,G.MapHIPAP,X,$];static TryAll(t,e){e||(e=1500);const s=t.substr(0,e).split("\n"),a=s.length,r=[];z.ListParsers.forEach((t=>r.push({p:t,title:t.getTitle(),valid:0})));for(let t=0;t<a;t++){const e=s[t];for(let t=0;t<z.ListParsers.length;t++){const s=z.ListParsers[t];let a;a="object"==typeof s?Y.ParseMap(e,s):s.try(e),a&&r[t].valid++}}return r}static GetParserInstance(t,e){const s=typeof t;let a;if("number"===s?a=z.ListParsers[t]:"string"===s&&(a=z.ListParsers.find((e=>e.getTitle()===t))),!a)return console.error("getParserInstance : Invalid argument"),!1;if("object"===typeof a){const t=new G(e);return t.setDefaultMap(a),t}return new a(e)}}class k{constructor(){this.obj={}}static ScaleLinear(t,e){const s=t[1]-t[0],a=e[1]-e[0];return r=>e[0]+a*((r-t[0])/s)}set(t,e,s){const a=k.ScaleLinear(e,s),r=k.ScaleLinear(s,e);this.obj[t]={domain:e,range:s,scale:a,reverseScale:r}}get(t,e){return!!this.obj[t]&&this.obj[t].scale(e)}getReverse(t,e){return!!this.obj[t]&&this.obj[t].reverseScale(e)}getDomain(t){return!!this.obj[t]&&this.obj[t].domain}getRange(t){if(this.obj[t])return this.obj[t].range}}MarineParser={},MarineParser.SB={},MarineParser.KB={},MarineParser.SEGY={},MarineParser.SR={},MarineParser.TD={},MarineParser.TXT={},MarineParser.MarineParserCommon=t,MarineParser.MPLog=e,MarineParser.Canvas2DPixel=class{constructor(t){this.canvas=void 0,this.ctx=void 0;const e=document.getElementById(t);if(e){try{const t=e.getContext("2d");this.ctx=t}catch(e){return void console.error(`Invalid Canvas id '${t}' not a canvas`)}this.canvas=e,this.w=this.canvas.width,this.h=this.canvas.height}else console.error(`Invalid Canvas id '${t}'`)}newImage(){this.imageData=this.ctx.getImageData(0,0,this.w,this.h),this.buf=new ArrayBuffer(this.imageData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf)}draw32(t,e,s){if(t<0||e<0||t>=this.w||e>=this.h)return;const a=e*this.w+t;this.buf32.length>a&&(this.buf32[a]=s)}draw32triple(t,e,s){t<0||e<0||t+1>=this.w||e+1>=this.h||(this.buf32[e*this.w+t]=s,this.buf32[(e+1)*this.w+t]=s,this.buf32[e*this.w+t+1]=s)}draw8(t,e,s){if(t<0||e<0||t>=this.w||e>=this.h)return;const a=4*(e*this.w+t);this.imageData[a]=s&&255,this.imageData[a+1]=s&&255,this.imageData[a+2]=s&&255,this.imageData[a+3]=s&&-1}putImage(){this.ctx.imageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.imageData.data.set(this.buf8),this.ctx.putImageData(this.imageData,0,0)}},MarineParser.GeoSpatial=s,MarineParser.Degree2Pixel=a,MarineParser.EndianDataView=r,MarineParser.SB.SeaSaveFileList=class{constructor(){this.listFiles=[],this.mapGroup={}}addFile(t){const e=t.name.match(/^(.*)\.([^.]*)$/i);if(e){const s=e[1].toLowerCase(),a=e[2].toLowerCase();-1!==["hex","bl","hdr","xmlcon"].findIndex((t=>a===t))&&(this.listFiles.push(t),this.mapGroup.hasOwnProperty(s)||(this.mapGroup[s]=new n),this.mapGroup[s].addFile(t))}}getGroup(t){if(this.mapGroup.hasOwnProperty(t))return this.mapGroup[t]}},MarineParser.SB.SeaSaveGroup=n,MarineParser.SB.SeaSaveChild=o,MarineParser.SB.SeaSaveHex=h,MarineParser.SB.SeaSaveXMLCON=p,MarineParser.SB.SeaConvert=d,MarineParser.SB.SeaParser=class{constructor(){this.group=void 0,this.hex=void 0,this.xmlcon=void 0,this.sensors=void 0}setGroup(t){this.group=t,this.setHex(t.getHex()),this.setXmlcon(t.getXmlcon())}setHex(t){this.hex=t}setXmlcon(t){this.xmlcon=t,this.sensors=t.getParsedMap()}parseDownUp(t){if(!this.hex||!this.xmlcon)return console.error("SeaParser.parseBrief no hex or no xmlcon"),!1;const e=this.hex.getLength();t||(t=parseInt(e/10));let s=t,a=0,r=e,i=0,n=null,o=0;for(;t===s;){i=parseInt((r-a)/t),i=i<1?1:i,n=this._loopInF2(a,r,i);let e=Math.floor(n-t/2),s=Math.ceil(n+t/2);if(a=e<a?a:e,r=s>r?r:s,t>r-a&&(t=r-a),o++,o>100){console.error("Invalid condition, program in infinite loop");break}}return{d:[0,n],u:[n+1,e-1]}}_loopInF2(t,e,s){let a=-999,r=-1;for(let i=t;i<=e;i+=s){const t=this.hex.parseDepthOnly(i);a<t.f2&&(a=t.f2,r=i)}return i}parseDepthTest(){const t=this.hex.getLength();let e,s,a=-1,r=-1;const i=(new Date).getTime();for(let s=0;s<t;s++){const t=this.hex.parseRaw(s);a<t.f2&&(a=t.f2,e=t)}const n=(new Date).getTime()-i,o=(new Date).getTime();for(let e=0;e<t;e++){const t=this.hex.parseDepthOnly(e);r<t.f2&&(r=t.f2,s=t)}const l=(new Date).getTime()-o;console.log(`count: ${t}, rawMS: ${n}, depthMS: ${l}`),console.log(`maxRaw ${a}, maxDepth ${r}`),console.log(e,s)}parseTest(){this.parseDownUp(),this.parseDepthTest()}},MarineParser.KB.EMEndianDataView=u,MarineParser.KB.EMParamInstall=f,MarineParser.KB.EMParamRuntime=g,MarineParser.KB.EMPosition=D,MarineParser.KB.EMXYZ88=T,MarineParser.KB.EMAll=U,MarineParser.KB.EMAllBatch2020=class extends U{batchSplitDataGrams(){let t=0;const e={invalid:{}};for(this.listXYZ=[],this.listDD=[],this.listPosition=[];t<this.byteLength;){const s=this.parseBrief(t),a=U.getType(s.type);if(!1===s.typeTitle?(e.invalid[s.type]||(e.invalid[s.type]=0),e.invalid[s.type]++):e[s.typeTitle]?e[s.typeTitle]++:e[s.typeTitle]=1,a.cls){const e=new a.cls(this.buffer,t,s.length+U.BYTE_LENGTH);e.setLittleEndian(this.littleEndian);const r=e.parseDetail();88===r.type?this.listXYZ.push(e):68===r.type?this.listDD.push(e):80===r.type&&this.listPosition.push(e)}t=t+s.length+U.BYTE_LENGTH}return e}findNearestPosition(t,e){let s=999999999,a=null;for(let r=0;r<this.listPosition.length;r++){const i=this.listPosition[r];if(i.parsedDetail.date!==t)continue;const n=Math.abs(e-i.parsedDetail.time);n<s&&(s=n,a=i)}return a}referenceXYZWithPosition(){this.getXYZSource().forEach(((t,e)=>{const s=this.findNearestPosition(t.parsedDetail.date,t.parsedDetail.time);t.referencedPos=s}))}getMinMaxXYZ(){let t=360,e=-360,s=360,a=-360,r=1e5,i=-1;return this.getXYZSource().forEach((n=>{n.xyz.forEach((n=>{n.lat<t&&(t=n.lat),n.lat>e&&(e=n.lat),n.lng<s&&(s=n.lng),n.lng>a&&(a=n.lng),n.z<r&&(r=n.z),n.z>i&&(i=n.z)}))})),{lat:{min:t,max:e},lng:{min:s,max:a},z:{min:r,max:i}}}getShrinkXYZ(){let t=360,e=-360,s=360,a=-360,r=1e5,i=-1;const n=[];return this.getXYZSource().forEach((o=>{const l=[];o.xyz.forEach((n=>{n.lat<t&&(t=n.lat),n.lat>e&&(e=n.lat),n.lng<s&&(s=n.lng),n.lng>a&&(a=n.lng),n.z<r&&(r=n.z),n.z>i&&(i=n.z),l.push([n.lat,n.lng,n.z])})),n.push(l)})),{lat:{min:t,max:e},lng:{min:s,max:a},z:{min:r,max:i},xyz:n}}getXYZSource(){return this.listXYZ.length>0?this.listXYZ:this.listDD}static binSearch(t,e){let s=0,a=t.length-1;for(;s<=a;){let r=Math.floor((s+a)/2);if(t[r]===e)return r;e<t[r]?a=r-1:s=r+1}return a}batch20200607(){console.log(new Date);const t=this.batchSplitDataGrams();console.log("Count Types"),console.log(t),console.log(new Date),this.referenceXYZWithPosition(),console.log(new Date),this.getXYZSource().forEach((t=>{t.xyz=t.parseWithPosition()})),console.log(new Date),console.log(this.getXYZSource());const e=this.getMinMaxXYZ();return console.log(e),e}batch20201109(){const t=new e;t.now("start");const s=this.batchSplitDataGrams();t.now("batch split"),this.referenceXYZWithPosition(),t.now("reference XYZ"),this.getXYZSource().forEach((t=>{t.xyz=t.parseWithPosition()})),t.now("parse with position xyz");const a=this.getMinMaxXYZ();t.now("minmax"),console.log(s),t.outconsole();return{types:s,minmax:a}}batch20210114(){const t=new e;t.now("start");const s=this.batchSplitDataGrams();t.now("batch split"),this.referenceXYZWithPosition(),t.now("reference XYZ"),this.getXYZSource().forEach((t=>{t.xyz=t.parseWithPosition()})),t.now("parse with position xyz");const a=this.getShrinkXYZ(),r={lat:[a.lat.min,a.lat.max],lng:[a.lng.min,a.lng.max],z:[a.z.min,a.z.max]};t.now("minmax"),console.log(s),t.outconsole();return{types:s,minMax:r,xyz:a.xyz}}},MarineParser.SEGY.SegYDataView=S,MarineParser.SEGY.SegY=E,MarineParser.SR.SimradEK80Raw=A,MarineParser.SR.SimradEK80RawBatch2020=class extends A{constructor(t,e,s){super(t,e,s),this.types=void 0,this.datagrams=void 0}batchSplitDataGrams(){const t=super.batchSplitDataGrams();return this.types=t.counts,this.datagrams=t.results,t}batchParseChannel(t){if(!this.datagrams)return console.error("No datagrams parsed, call 'batchSplitDataGrams' first"),!1;const e=[];return this.datagrams.forEach((s=>{if(A.TYPE_RAW3!==s.getBrief().title)return;if(t!==s.getDetail().channelId)return;const a=JSON.parse(JSON.stringify(s,((t,e)=>"bigint"==typeof e?e.toString()+"n":e)));a.parsedDetail.samples=s.getValues(),e.push(a)})),e}},MarineParser.TD.TDPD0=V,MarineParser.TD.PD0=v,MarineParser.TD.PD0Header=y,MarineParser.TD.PD0Fixed=C,MarineParser.TD.PD0Variable=_,MarineParser.TD.PD0Navigation=F,MarineParser.TD.PD0Velocity=x,MarineParser.TXT.TXTCSVHelper=z,MarineParser.TXT.TXTCSV=Y,MarineParser.TXT.TXTCSVMap=G,MarineParser.TXT.TXTCSVSeapath=X,MarineParser.TXT.TXTCSVPCO2=$,MarineParser.DOMUtil=class{static Span(t){const e=document.createElement("span");return e.innerHTML=t,e}static P(t){const e=document.createElement("p");return e.innerHTML=t,e}static SetHtml(t,e){document.getElementById(t).innerHTML=e}static GetChecked(t){const e=document.getElementsByName(t),s=[];for(let t=0;t<e.length;t++){const a=e[t];a.checked&&s.push(a)}return s}},MarineParser.FileUtil=class{static async readFileString(t){return new Promise(((e,s)=>{const a=new FileReader;a.onload=t=>{e(a.result)},a.onerror=t=>{s(t)},a.readAsText(t)}))}static async readFileChunkString(t){const e=t.stream().getReader(),s=await e.read();return(new TextDecoder).decode(s.value.buffer)}static download(t,e){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}},MarineParser.ScaleBox=k,MarineParser.DNDFileList=class{constructor(t){this.listFiles=[],this.mapGroup={},this.listExts=t}addFile(t){const e=t.name.match(/^(.*)\.([^.]*)$/i);if(e){const s=e[1],a=e[2].toLowerCase();-1!==this.listExts.findIndex((t=>a===t))&&(this.listFiles.push(t),this.mapGroup.hasOwnProperty(s)||(this.mapGroup[s]=[]),this.mapGroup[s].push(t))}}getGroup(t){if(this.mapGroup.hasOwnProperty(t))return this.mapGroup[t]}setButton(t,e){const s=document.getElementById(t);s.innerHTML="",Object.keys(this.mapGroup).forEach((t=>{const a=document.createElement("button");a.innerText=t,a.addEventListener("click",(()=>{e(this.mapGroup[t])})),s.append(a)}))}static async readFileArrayBuffer(t){return new Promise(((e,s)=>{const a=new FileReader;a.onloadend=()=>{e(a.result)},a.readAsArrayBuffer(t)}))}static LocalFile(t,e){["dragenter","dragover","dragleave","drop"].forEach((e=>{t.addEventListener(e,(t=>{t.preventDefault(),t.stopPropagation()}),!1)})),["dragenter","dragover"].forEach((e=>{t.addEventListener(e,(()=>{t.classList.add("highlight")}),!1)})),["dragleave","drop"].forEach((e=>{t.addEventListener(e,(()=>{t.classList.remove("highlight")}),!1)})),t.addEventListener("drop",(t=>{let s=t.dataTransfer.files;e(s)}),!1);const s=t.querySelector('input[type="file"]');s.addEventListener("change",(()=>{e(s.files)}))}},window.__MARINE_PARSER_OBJECT_2021__=MarineParser}();
